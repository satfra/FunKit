name: run-tests
on: push
jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: wolframresearch/wolframengine:latest
      options: --user root
    env:
      WOLFRAM_SYSTEM_ID: Linux-x86-64

    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: Setup build and install
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAM_LICENSE_ENTITLEMENT_ID }}
        run: |
          apt-get update
          apt-get install -y cmake make git form unzip
          mkdir -p $GITHUB_WORKSPACE/build
          cd $GITHUB_WORKSPACE/build
          cmake -DCMAKE_BUILD_TYPE=Release $GITHUB_WORKSPACE
          make install

      - name: Run tests
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAM_LICENSE_ENTITLEMENT_ID }}
        run: |
          cd $GITHUB_WORKSPACE/build
          make test | tee test.log
          cat "## Test output" >> $GITHUB_STEP_SUMMARY
          cat "```bash\n" >> $GITHUB_STEP_SUMMARY
          cat test.log >> $GITHUB_STEP_SUMMARY
          cat "\n```" >> $GITHUB_STEP_SUMMARY
