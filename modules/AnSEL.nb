(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[    187174,       4164]
NotebookOptionsPosition[    183416,       4088]
NotebookOutlinePosition[    183872,       4106]
CellTagsIndexPosition[    183829,       4103]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"SetOptions", "[", 
  RowBox[{
   RowBox[{"EvaluationNotebook", "[", "]"}], ",", 
   RowBox[{"AutoGeneratedPackage", "->", "\"\<AnSEL.m\>\""}]}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.933907062001917*^9, 3.933907088477437*^9}, 
   3.9356618434708548`*^9, 3.935744927606638*^9, {3.935833716539812*^9, 
   3.93583371672362*^9}, {3.9507222866535883`*^9, 3.95072228934137*^9}, {
   3.950850838405504*^9, 3.950850842475651*^9}, {3.95163261282847*^9, 
   3.951632615369035*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"33cd48af-4550-42b3-9c95-127f2f1ee635"],

Cell[CellGroupData[{

Cell["AnSEL - Analysis and Simplification of Equations with Loops", "Title",
 CellChangeTimes->{{3.9516327002842617`*^9, 
  3.9516327244520073`*^9}},ExpressionUUID->"45e0855c-4bc3-42ae-aaff-\
d5b51f4ff40a"],

Cell[CellGroupData[{

Cell["Exports", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}, {3.951839308727314*^9, 
  3.951839310008635*^9}},ExpressionUUID->"e11489d7-57c3-46f3-92a7-\
9bd632e0d9ac"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetLoopMomentumName", "::", "usage"}], "=", "\"\<\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FRoute", "::", "usage"}], "=", "\"\<\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FUnroute", "::", "usage"}], "=", "\"\<\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSimplify", "::", "usage"}], "=", "\"\<\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"loopMomentum", "::", "usage"}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.95183931636378*^9, 3.951839381192008*^9}, {
   3.952058405271412*^9, 3.9520584193976583`*^9}, {3.952080985264083*^9, 
   3.952080987823354*^9}, {3.953437178522677*^9, 3.953437181466061*^9}, {
   3.953449785726767*^9, 3.953449793530739*^9}, 3.953531332887919*^9, 
   3.953531492658977*^9, {3.953531525682482*^9, 
   3.9535315295462933`*^9}},ExpressionUUID->"0d5d392c-52cd-44ef-853d-\
02a6cf9d51ce"]
}, Closed]],

Cell[CellGroupData[{

Cell["Begin Private", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}, {3.951719085230523*^9, 3.951719086330667*^9}, {
  3.95339039462521*^9, 
  3.953390400047613*^9}},ExpressionUUID->"445e38bc-f471-4fa5-8f01-\
377cf28ca16d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}], ";"}]], "Code",
 CellChangeTimes->{
  3.933840441045422*^9, {3.953390641751967*^9, 3.953390642246134*^9}, {
   3.953390952640456*^9, 
   3.953390952803998*^9}},ExpressionUUID->"466d64ef-678a-421d-bafe-\
cb91fb62b4c6"]
}, Closed]],

Cell[CellGroupData[{

Cell["Global setup redefinitions", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}, {3.95343637598921*^9, 
  3.9534363794891653`*^9}},ExpressionUUID->"1b5ba65f-49a1-4935-a430-\
53c938d8e351"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"FRoute", "[", "expr_FEq", "]"}], "/;", 
     RowBox[{
      RowBox[{"Head", "[", "$GlobalSetup", "]"}], "=!=", "Symbol"}]}], ":=", 
    RowBox[{"FRoute", "[", 
     RowBox[{"$GlobalSetup", ",", "expr"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"FUnroute", "[", "expr_", "]"}], "/;", 
     RowBox[{
      RowBox[{"Head", "[", "$GlobalSetup", "]"}], "=!=", "Symbol"}]}], ":=", 
    RowBox[{"FUnroute", "[", 
     RowBox[{"$GlobalSetup", ",", "expr"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSimplify", "[", "expr_FEq", "]"}], "/;", 
    RowBox[{
     RowBox[{"Head", "[", "$GlobalSetup", "]"}], "=!=", "Symbol"}]}], ":=", 
   RowBox[{"FSimplify", "[", 
    RowBox[{"$GlobalSetup", ",", "expr"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSimplify", "[", 
     RowBox[{"expr_FEq", ",", 
      RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], "/;", 
    RowBox[{
     RowBox[{"Head", "[", "$GlobalSetup", "]"}], "=!=", "Symbol"}]}], ":=", 
   RowBox[{"FSimplify", "[", 
    RowBox[{"$GlobalSetup", ",", "expr", ",", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"Sequence", "@@", 
         RowBox[{"Thread", "[", 
          RowBox[{"Rule", "@@", 
           RowBox[{"{", 
            RowBox[{"#", ",", 
             RowBox[{"OptionValue", "[", 
              RowBox[{"FSimplify", ",", "#"}], "]"}]}], "}"}]}], "]"}]}], 
        "&"}], "@", 
       RowBox[{"Keys", "[", 
        RowBox[{"Options", "[", "FSimplify", "]"}], "]"}]}], ")"}]}], "]"}]}],
   ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.953436381825996*^9, 3.95343638686135*^9}, {
  3.953437179947053*^9, 3.953437184629566*^9}, {3.9534497972191753`*^9, 
  3.953449830027244*^9}, {3.953463021544742*^9, 3.953463034496512*^9}, {
  3.953531333966649*^9, 3.953531345545542*^9}, {3.9536357067021837`*^9, 
  3.953635744966282*^9}, {3.953635836241075*^9, 3.953635854522024*^9}, {
  3.953635907162016*^9, 3.9536359677697678`*^9}, {3.953636070170401*^9, 
  3.953636097598281*^9}, {3.953636155866199*^9, 
  3.953636188698638*^9}},ExpressionUUID->"dd231b36-4dd1-41ed-8027-\
d5c3d185d878"]
}, Closed]],

Cell[CellGroupData[{

Cell["Global variables", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}},ExpressionUUID->"d65e8f2b-6500-4348-8918-\
912b67b13cd9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ModuleLoaded", "::", "dependency"}], "=", 
    "\"\<The module `1` requires `2`, which has not been loaded.\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ModuleLoaded", "[", "FunKit", "]"}], "=!=", "True"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"ModuleLoaded", "::", "dependency"}], ",", "\"\<AnSEL\>\"", 
        ",", "\"\<FunKit\>\""}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Abort", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ModuleLoaded", "[", "FEDeriK", "]"}], "=!=", "True"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"ModuleLoaded", "::", "dependency"}], ",", "\"\<AnSEL\>\"", 
        ",", "\"\<FEDeriK\>\""}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Abort", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ModuleLoaded", "[", "AnSEL", "]"}], "=", "True"}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.951279357886877*^9, 3.951279421240814*^9}, {
   3.9512794606622543`*^9, 3.951279475842711*^9}, {3.951279581390761*^9, 
   3.9512796956111917`*^9}, {3.951279782883439*^9, 3.9512797869913473`*^9}, {
   3.9516326303484573`*^9, 3.951632637292129*^9}, {3.951829731107336*^9, 
   3.9518297457785177`*^9}, 3.9518298128083982`*^9, {3.951829875255785*^9, 
   3.951829915394566*^9}, {3.951832913059966*^9, 3.9518329170830593`*^9}, {
   3.9533910293325*^9, 3.95339103805589*^9}, {3.953395069744735*^9, 
   3.9533950765805283`*^9}, {3.953395141092717*^9, 3.95339514783283*^9}, {
   3.9533952669458857`*^9, 
   3.953395267540954*^9}},ExpressionUUID->"0a00f2e0-9e12-4855-8a8a-\
da6773cee6a6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetLoopMomentumName", "[", "name_String", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"StringQ", "[", "$loopMomentumName", "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Unprotect", "@@", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"$loopMomentumName", "<>", 
            RowBox[{"ToString", "[", "idx", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"idx", ",", "1", ",", "50"}], "}"}]}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"$loopMomentumName", "=", "name"}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"ClearAll", "@@", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"$loopMomentumName", "<>", 
          RowBox[{"ToString", "[", "idx", "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", "50"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Protect", "@@", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"$loopMomentumName", "<>", 
          RowBox[{"ToString", "[", "idx", "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", "50"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Unprotect", "[", "$availableLoopMomenta", "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"$availableLoopMomenta", ":=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Symbol", "[", 
          RowBox[{"$loopMomentumName", "<>", 
           RowBox[{"ToString", "[", "idx", "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", "50"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Protect", "[", "$availableLoopMomenta", "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetLoopMomentumName", "[", "\"\<l\>\"", "]"}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.951829755107589*^9, 3.951829794354896*^9}, {
  3.951829909348638*^9, 3.951829913359212*^9}, {3.953395209881303*^9, 
  3.953395217184366*^9}, {3.9533953171170483`*^9, 3.953395385204777*^9}, {
  3.9533957563619013`*^9, 
  3.953395785100814*^9}},ExpressionUUID->"19d3217d-a7f5-4ace-98d5-\
bc282d55350e"]
}, Closed]],

Cell[CellGroupData[{

Cell["Index routing", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}, {3.951633303953529*^9, 3.9516333082480516`*^9}, {
  3.951751340146393*^9, 
  3.951751341799527*^9}},ExpressionUUID->"9aa34791-bba0-4b08-b6c9-\
8fe4e2793307"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "A", " ", "convenience", " ", "function", " ", "to", " ", "quickly", " ", 
    "obtain", " ", "the", " ", "index", " ", "structure", " ", "of", " ", "a",
     " ", "given", " ", 
    RowBox[{"field", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"FieldSetupIndices", "[", 
     RowBox[{"setup_", ",", "field_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"List", "@@", 
       RowBox[{"SelectFirst", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Flatten", "@", 
          RowBox[{"Values", "[", 
           RowBox[{"setup", "[", "\"\<FieldSpace\>\"", "]"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "[", "#", "]"}], "===", "field"}], "&"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9517589995151367`*^9, 3.951759172050156*^9}, {
  3.9517592045705147`*^9, 3.951759243198325*^9}, {3.951838627565138*^9, 
  3.951838648276087*^9}},ExpressionUUID->"42d0a911-1a57-464e-87cc-\
ca3a6c174093"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FRoute", "::", "undeterminedFields"}], 
   "=", "\"\<Cannot route indices in expressions with undetermined \
fields.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FRoute", "::", "momentaFailed"}], 
   "=", "\"\<Cannot route momenta in the given expression. Final momentum \
conservation read `1`\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FRoute", "::", "conservationFail"}], 
    "=", "\"\<Momentum conservation could not be fulfilled. Error in \
`1`\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FRoute", "[", 
     RowBox[{"setup_", ",", "expr_FTerm"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "openIndices", ",", "closedIndices", ",", "objects", ",", 
        "\[IndentingNewLine]", 
        RowBox[{"ret", "=", 
         RowBox[{"ReduceFTerm", "[", 
          RowBox[{"setup", ",", 
           RowBox[{"ReduceIndices", "[", 
            RowBox[{"setup", ",", "expr"}], "]"}]}], "]"}]}], ",", "doFields",
         ",", "idx", ",", "a", ",", "\[IndentingNewLine]", "indPos", ",", 
        "assocField", ",", "subObj", ",", "subMom", ",", "subExtMom", ",", 
        "\[IndentingNewLine]", "indStruct", ",", "externalIndices", ",", 
        "externalMomenta", ",", "\[IndentingNewLine]", "f", ",", "momRepl", ",",
         "i", ",", "mom", ",", "loopMomenta", ",", "sidx", ",", "discard"}], 
       "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FunKitDebug", "[", 
        RowBox[{
        "1", ",", "\"\<FRoute: routing the sub-term \>\"", ",", "expr"}], 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"We", " ", "first", " ", "get", " ", "all", " ", "closed"}], 
         ",", " ", 
         RowBox[{
         "open", " ", "indices", " ", "and", " ", "all", " ", "indexed", " ", 
          
          RowBox[{"objects", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"doFields", "=", 
        RowBox[{"replFields", "[", "setup", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"openIndices", "=", 
        RowBox[{"Sort", "@", 
         RowBox[{"GetOpenSuperIndices", "[", 
          RowBox[{"setup", ",", "ret"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"closedIndices", "=", 
        RowBox[{"GetClosedSuperIndices", "[", 
         RowBox[{"setup", ",", "ret"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"objects", "=", 
        RowBox[{
         RowBox[{"ExtractObjectsWithIndex", "[", 
          RowBox[{"setup", ",", "ret"}], "]"}], "//.", "doFields"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
         "If", " ", "there", " ", "are", " ", "any", " ", "undetermined", " ",
           "fields"}], ",", " ", 
         RowBox[{"we", " ", "cannot", " ", "route", " ", 
          RowBox[{"indices", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MemberQ", "[", 
          RowBox[{
           RowBox[{"objects", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "1"}], "]"}], "]"}], ",", "AnyField", ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "4"}], "}"}]}], "]"}], ",", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"FRoute", "::", "undeterminedFields"}], "]"}], ";", 
          RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"As", " ", "a", " ", "first", " ", "step"}], ",", " ", 
         RowBox[{
         "we", " ", "insert", " ", "the", " ", "correct", " ", "index", " ", 
          "structures", " ", "into", " ", "all", " ", "superindices", " ", 
          "and", " ", "define", " ", "momentum", " ", "variables", " ", "at", 
          " ", "every", " ", "single", " ", 
          RowBox[{"vertex", ".", "\[IndentingNewLine]", "We"}], " ", "loop", " ",
           "over", " ", "all", " ", "closed", " ", 
          RowBox[{"indices", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "The", " ", "indexed", " ", "object", " ", "we", " ", "currently", " ", 
          RowBox[{"modify", ".", " ", "There"}], " ", "are", " ", "always", " ",
           "two", " ", "and", " ", "we", " ", "simply", " ", "grab", " ", 
          "the", " ", 
          RowBox[{"first", "."}]}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"subObj", "=", 
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{"objects", ",", 
              RowBox[{
               RowBox[{"MemberQ", "[", 
                RowBox[{"#", ",", 
                 RowBox[{"closedIndices", "[", 
                  RowBox[{"[", "idx", "]"}], "]"}], ",", "Infinity"}], "]"}], 
               "&"}]}], "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "The", " ", "position", " ", "of", " ", "the", " ", "current", " ",
             "index", " ", "inside", " ", "the", " ", "subObj"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"indPos", "=", 
           RowBox[{
            RowBox[{"FirstPosition", "[", 
             RowBox[{
              RowBox[{"subObj", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", 
              RowBox[{"closedIndices", "[", 
               RowBox[{"[", "idx", "]"}], "]"}]}], "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "See", " ", "what", " ", "kind", " ", "of", " ", "field", " ", 
            "is", " ", "associated", " ", "with", " ", "the", " ", "index"}], 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"assocField", "=", 
           RowBox[{"subObj", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "indPos"}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Grab", " ", "the", " ", "index", " ", "structure", " ", "of", " ",
             "this", " ", "field", " ", "from", " ", "the", " ", "setup", " ",
             "and", " ", "assign", " ", "a", " ", "new", " ", "momentum", " ",
             "variable"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"indStruct", "=", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"MatchQ", "[", 
                 RowBox[{"#", ",", "_Symbol"}], "]"}], ",", 
                RowBox[{"Unique", "[", 
                 RowBox[{"SymbolName", "[", "#", "]"}], "]"}], ",", "#"}], 
               "]"}], "&"}], ",", 
             RowBox[{"FieldSetupIndices", "[", 
              RowBox[{"setup", ",", "assocField"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"indStruct", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "=", 
           RowBox[{"loopMomentum", "[", 
            RowBox[{"indStruct", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "replace", " ", "all", " ", "occurences", " ", "of", " ", "the", " ",
              "superindex", " ", "with", " ", "the", " ", "fitting", " ", 
             "index", " ", 
             RowBox[{"structure", ".", " ", "\[IndentingNewLine]", "We"}], " ",
              "want", " ", "to", " ", "keep", " ", "the", " ", "index", " ", 
             "sign", " ", "in", " ", "the", " ", "momenta"}], ",", " ", 
            RowBox[{
            "but", " ", "remove", " ", "it", " ", "from", " ", "the", " ", 
             "group", " ", "indices"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"ret", "=", 
           RowBox[{"ret", "/.", 
            RowBox[{
             RowBox[{"closedIndices", "[", 
              RowBox[{"[", "idx", "]"}], "]"}], "->", "indStruct"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"objects", "=", 
           RowBox[{"objects", "/.", 
            RowBox[{
             RowBox[{"closedIndices", "[", 
              RowBox[{"[", "idx", "]"}], "]"}], "->", "indStruct"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "indStruct", "]"}], ">", "1"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"ret", "=", 
              RowBox[{"ret", "/.", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", 
                  RowBox[{"indStruct", "[", 
                   RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "->", 
                RowBox[{"indStruct", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"objects", "=", 
              RowBox[{"objects", "/.", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"-", 
                  RowBox[{"indStruct", "[", 
                   RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "->", 
                RowBox[{"indStruct", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}]}]}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", 
         "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", 
           RowBox[{"Length", "[", "closedIndices", "]"}]}], "}"}]}], "]"}], ";",
        "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Next", ",", " ", 
         RowBox[{"we", " ", "treat", " ", "the", " ", "external", " ", 
          RowBox[{"superindices", ".", " ", "We"}], " ", "assign", " ", "to", 
          " ", "each", " ", "an", " ", "open", " ", "group", " ", "structure",
           " ", "and", " ", "a", " ", "new", " ", "momentum", " ", "p1"}], ",",
          "p2", ",", 
         RowBox[{
         "...", " ", "\[IndentingNewLine]", "Momentum", " ", "conservation", " ",
           "is", " ", "already", " ", "enforced", " ", "here"}], ",", " ", 
         RowBox[{
          RowBox[{"i", ".", "e", ".", " ", 
           RowBox[{
            SubscriptBox["\[Sum]", "i"], 
            SubscriptBox["p", "i"]}]}], "=", 
          RowBox[{
           RowBox[{"0", " ", "and", " ", "we", " ", "choose", " ", 
            SubscriptBox["p", "n"]}], "=", 
           RowBox[{"-", 
            RowBox[{
             SubscriptBox["\[Sum]", 
              RowBox[{"i", "<", "n"}]], 
             RowBox[{
              SubscriptBox["p", "i"], " ", "for", " ", "the", " ", "last", " ",
               "momentum", " ", 
              RowBox[{
               SubscriptBox["p", "n"], "."}]}]}]}]}]}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"externalIndices", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"idx", ",", "1", ",", 
            RowBox[{"Length", "[", "openIndices", "]"}]}], "}"}]}], "]"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"see", " ", "above"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"subObj", "=", 
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{"objects", ",", 
              RowBox[{
               RowBox[{"MemberQ", "[", 
                RowBox[{"#", ",", 
                 RowBox[{"openIndices", "[", 
                  RowBox[{"[", "idx", "]"}], "]"}], ",", "Infinity"}], "]"}], 
               "&"}]}], "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"indPos", "=", 
           RowBox[{
            RowBox[{"FirstPosition", "[", 
             RowBox[{
              RowBox[{"subObj", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", 
              RowBox[{"openIndices", "[", 
               RowBox[{"[", "idx", "]"}], "]"}]}], "]"}], "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"assocField", "=", 
           RowBox[{"subObj", "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "indPos"}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"indStruct", "=", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"MatchQ", "[", 
                 RowBox[{"#", ",", "_Symbol"}], "]"}], ",", 
                RowBox[{"Symbol", "[", 
                 RowBox[{
                  RowBox[{"SymbolName", "[", "#", "]"}], "<>", 
                  RowBox[{"ToString", "[", "idx", "]"}]}], "]"}], ",", "#"}], 
               "]"}], "&"}], ",", 
             RowBox[{"FieldSetupIndices", "[", 
              RowBox[{"setup", ",", "assocField"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            SubscriptBox["p", "n"], "=", 
            RowBox[{"-", 
             RowBox[{
              SubscriptBox["\[Sum]", 
               RowBox[{"i", "<", "n"}]], 
              SubscriptBox["p", "i"]}]}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"idx", "===", 
             RowBox[{"Length", "[", "openIndices", "]"}]}], ",", 
            RowBox[{
             RowBox[{"indStruct", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "=", 
             RowBox[{"-", 
              RowBox[{"Total", "[", 
               RowBox[{
                RowBox[{"Values", "[", "externalIndices", "]"}], "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"idx", "-", "1"}]}], ",", "1"}], "]"}], "]"}], 
               "]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"ret", "=", 
           RowBox[{"ret", "/.", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"-", 
               RowBox[{"openIndices", "[", 
                RowBox[{"[", "idx", "]"}], "]"}]}], ")"}], "->", 
             "indStruct"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"ret", "=", 
           RowBox[{"ret", "/.", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"openIndices", "[", 
               RowBox[{"[", "idx", "]"}], "]"}], ")"}], "->", 
             "indStruct"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"objects", "=", 
           RowBox[{"objects", "/.", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"-", 
               RowBox[{"openIndices", "[", 
                RowBox[{"[", "idx", "]"}], "]"}]}], ")"}], "->", 
             "indStruct"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"objects", "=", 
           RowBox[{"objects", "/.", 
            RowBox[{
             RowBox[{"openIndices", "[", 
              RowBox[{"[", "idx", "]"}], "]"}], "->", "indStruct"}]}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "This", " ", "is", " ", "information", " ", "for", " ", "the", " ",
              "user"}], ",", " ", 
            RowBox[{"which", " ", "we", " ", "will", " ", 
             RowBox[{"return", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"externalIndices", "[", 
            RowBox[{"[", "idx", "]"}], "]"}], "=", 
           RowBox[{
            RowBox[{"openIndices", "[", 
             RowBox[{"[", "idx", "]"}], "]"}], "->", "indStruct"}]}], ";"}], 
         "\[IndentingNewLine]", "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", 
           RowBox[{"Length", "[", "openIndices", "]"}]}], "}"}]}], "]"}], ";",
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "extract", " ", "a", " ", "list", " ", "of", " ", "all", " ", "new", " ",
          "external", " ", "momenta"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"externalMomenta", "=", 
        RowBox[{
         RowBox[{"Values", "[", "externalIndices", "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"FunKitDebug", "[", 
        RowBox[{
        "2", ",", "\"\<FRoute: Determined external momenta as \>\"", ",", 
         "externalMomenta"}], "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Now", ",", " ", 
         RowBox[{"we", " ", "do", " ", "the", " ", "momentum", " ", 
          RowBox[{"routing", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"subObj", "=", 
           RowBox[{"objects", "[", 
            RowBox[{"[", "idx", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"subMom", "=", 
           RowBox[{"subObj", "[", 
            RowBox[{"[", 
             RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "See", " ", "if", " ", "the", " ", "object", " ", "has", " ", 
            "any", " ", "external", " ", 
            RowBox[{"(", 
             RowBox[{"sub", "-"}], ")"}], "momenta"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"subExtMom", "=", 
           RowBox[{"Select", "[", 
            RowBox[{"subMom", ",", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"ContainsAny", "[", 
                RowBox[{"externalMomenta", ",", 
                 RowBox[{"makePosIdx", "/@", 
                  RowBox[{"Flatten", "[", 
                   RowBox[{"{", 
                    RowBox[{"#", "/.", 
                    RowBox[{
                    RowBox[{"Plus", "[", 
                    RowBox[{"a_", ",", "b__"}], "]"}], ":>", 
                    RowBox[{"List", "[", 
                    RowBox[{"a", ",", "b"}], "]"}]}]}], "}"}], "]"}]}]}], 
                "]"}], ")"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"FunKitDebug", "[", 
           RowBox[{
           "3", ",", "\"\<FRoute: routing the object \>\"", ",", "subObj"}], 
           "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "if", " ", "momentum", " ", "conservation", " ", "is", " ", 
             "already", " ", "fulfilled"}], ",", " ", 
            RowBox[{"do", " ", "nothing"}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Total", "@", "subMom"}], "===", "0"}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"Case", " ", "1"}], ":", " ", 
            RowBox[{
            "we", " ", "have", " ", "no", " ", "external", " ", "momentum", " ",
              "anywhere", " ", "in", " ", "the", " ", "legs", " ", "of", " ", 
             "the", " ", "current", " ", "object"}]}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "subExtMom", "]"}], "===", "0"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
              "If", " ", "we", " ", "have", " ", "nothing", " ", "to", " ", 
               "enforce"}], ",", " ", 
              RowBox[{"skip", " ", "this", " ", "object"}]}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", 
                 RowBox[{"subObj", "[", 
                  RowBox[{"[", 
                   RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], "<",
                 "2"}], ",", 
               RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{"for", " ", "safety"}], ",", " ", 
               RowBox[{
                RowBox[{
                "we", " ", "try", " ", "to", " ", "route", " ", "our", " ", 
                 "momenta", " ", "through", " ", 
                 RowBox[{"fermions", ".", " ", "At"}], " ", "1"}], "-", 
                RowBox[{"loop", " ", "this", " ", "is", " ", "irrelevant"}]}],
                ",", " ", 
               RowBox[{
                RowBox[{"at", " ", "n"}], "-", 
                RowBox[{"loop", " ", "it", " ", "is", " ", 
                 RowBox[{"not", "."}]}]}]}], "*)"}], "\[IndentingNewLine]", 
             RowBox[{"f", "=", 
              RowBox[{
               RowBox[{"FirstPosition", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"IsFermion", "[", 
                    RowBox[{"setup", ",", "#"}], "]"}], "&"}], "/@", 
                  RowBox[{"subObj", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], ",", "True"}], "]"}], "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"f", "===", "\"\<NotFound\>\""}], ",", 
               RowBox[{"f", "=", "1"}]}], "]"}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"mom", "=", 
              RowBox[{"makePosIdx", "@", 
               RowBox[{
                RowBox[{"Select", "[", 
                 RowBox[{
                  RowBox[{"Flatten", "[", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "f", ",", "1"}], "]"}], "]"}], "//.", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Plus", "[", 
                    RowBox[{"a_", ",", "b__"}], "]"}], ":>", 
                    RowBox[{"List", "[", 
                    RowBox[{"a", ",", "b"}], "]"}]}], ",", 
                    RowBox[{
                    RowBox[{"Times", "[", 
                    RowBox[{"a_loopMomentum", ",", "b__"}], "]"}], ":>", 
                    RowBox[{"List", "[", 
                    RowBox[{"a", ",", "b"}], "]"}]}]}], "}"}]}], "}"}], "]"}],
                   ",", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"MatchQ", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"loopMomentum", "[", "_", "]"}]}], "]"}], "||", 
                    RowBox[{"MatchQ", "[", 
                    RowBox[{
                    RowBox[{"-", "#"}], ",", 
                    RowBox[{"loopMomentum", "[", "_", "]"}]}], "]"}]}], ")"}],
                    "&"}]}], "]"}], "[", 
                RowBox[{"[", "1", "]"}], "]"}]}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"momRepl", "=", 
              RowBox[{
               RowBox[{"Solve", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Total", "[", 
                   RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], 
                  "==", "0"}], ",", "mom"}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"objects", "=", 
              RowBox[{"objects", "/.", "momRepl"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"ret", "=", 
              RowBox[{"ret", "/.", "momRepl"}]}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"FunKitDebug", "[", 
              RowBox[{
              "3", ",", "\"\<FRoute: routing a momentum as \>\"", ",", 
               "momRepl"}], "]"}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"Continue", "[", "]"}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{"Case", " ", "2"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", "subExtMom", "]"}], "<=", 
             RowBox[{"Length", "[", "subMom", "]"}]}], ",", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "discard", " ", "helps", " ", "us", " ", "to", " ", "iterate", " ",
               "thorugh", " ", "momentum", " ", 
              RowBox[{"arguments", ".", " ", "sidx"}], " ", "iterates", " ", 
              "through", " ", "the", " ", "loopMomenta", " ", "contained", " ",
               "in", " ", "each", " ", "momenum", " ", "argument"}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"discard", "[", "_", "]"}], "=", "False"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"sidx", "=", "0"}], ";", "\[IndentingNewLine]", 
             RowBox[{"While", "[", 
              RowBox[{
               RowBox[{"sidx", "<", "1000"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"sidx", "++"}], ";", "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{"for", " ", "safety"}], ",", " ", 
                  RowBox[{
                  "we", " ", "try", " ", "to", " ", "route", " ", "our", " ", 
                   "momenta", " ", "through", " ", 
                   RowBox[{"fermions", "."}]}]}], "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{"f", "=", 
                 RowBox[{
                  RowBox[{"FirstPosition", "[", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"Table", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IsFermion", "[", 
                    RowBox[{"setup", ",", 
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "i"}], "]"}], "]"}]}], "]"}], "&&", 
                    RowBox[{"MemberQ", "[", 
                    RowBox[{
                    RowBox[{"makePosIdx", "/@", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "i", ",", "1"}], "]"}], "]"}], "/.", 
                    RowBox[{
                    RowBox[{"Plus", "[", 
                    RowBox[{"a_", ",", "b__"}], "]"}], ":>", 
                    RowBox[{"List", "[", 
                    RowBox[{"a", ",", "b"}], "]"}]}]}], "}"}], "]"}]}], ",", 
                    RowBox[{"loopMomentum", "[", "__", "]"}]}], "]"}], "&&", 
                    RowBox[{"Not", "@", 
                    RowBox[{"discard", "[", "i", "]"}]}]}], ")"}], 
                    "\[IndentingNewLine]", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", 
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "}"}]}], "]"}], 
                    "\[IndentingNewLine]", ",", "True"}], "]"}], "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "If", " ", "no", " ", "fermions", " ", "are", " ", 
                   "present"}], ",", " ", 
                  RowBox[{
                  "simply", " ", "grab", " ", "the", " ", "index", " ", 
                   "which", " ", "does", " ", "not", " ", "contain", " ", 
                   "external", " ", 
                   RowBox[{"momenta", "."}]}]}], "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"f", "===", "\"\<NotFound\>\""}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"f", "=", 
                    RowBox[{
                    RowBox[{"FirstPosition", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"Table", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"MemberQ", "[", 
                    RowBox[{
                    RowBox[{"makePosIdx", "/@", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "i", ",", "1"}], "]"}], "]"}], "/.", 
                    RowBox[{
                    RowBox[{"Plus", "[", 
                    RowBox[{"a_", ",", "b__"}], "]"}], ":>", 
                    RowBox[{"List", "[", 
                    RowBox[{"a", ",", "b"}], "]"}]}]}], "}"}], "]"}]}], ",", 
                    RowBox[{"loopMomentum", "[", "__", "]"}]}], "]"}], "&&", 
                    RowBox[{"Not", "@", 
                    RowBox[{"discard", "[", "i", "]"}]}]}], 
                    "\[IndentingNewLine]", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", 
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "}"}]}], "]"}], 
                    "\[IndentingNewLine]", ",", "True"}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], ";", " ", 
                   "\[IndentingNewLine]", "\[IndentingNewLine]", 
                   RowBox[{"(*", 
                    RowBox[{
                    RowBox[{
                    "The", " ", "only", " ", "other", " ", "possibility", " ",
                     "is", " ", "that", " ", "all", " ", "momenta", " ", 
                    "are", " ", 
                    RowBox[{"external", ".", " ", "In"}], " ", "that", " ", 
                    "case"}], ",", " ", 
                    RowBox[{
                    "we", " ", "do", " ", "nothing", " ", "but", " ", "check",
                     " ", 
                    RowBox[{"consistency", "."}]}]}], "*)"}], 
                   "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"f", "===", "\"\<NotFound\>\""}], ",", 
                    RowBox[{
                    RowBox[{"Break", "[", "]"}], ";"}]}], "]"}], ";"}]}], 
                 "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
                "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{"Extract", " ", "all", " ", "loop", " ", "momenta"}],
                  "*)"}], "\[IndentingNewLine]", 
                RowBox[{"mom", "=", 
                 RowBox[{"makePosIdx", "/@", 
                  RowBox[{"Select", "[", 
                   RowBox[{
                    RowBox[{"Flatten", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "f", ",", "1"}], "]"}], "]"}], "/.", 
                    RowBox[{
                    RowBox[{"Plus", "[", 
                    RowBox[{"a_", ",", "b__"}], "]"}], ":>", 
                    RowBox[{"List", "[", 
                    RowBox[{"a", ",", "b"}], "]"}]}]}], "}"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"MatchQ", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"loopMomentum", "[", "_", "]"}]}], "]"}], "||", 
                    RowBox[{"MatchQ", "[", 
                    RowBox[{
                    RowBox[{"-", "#"}], ",", 
                    RowBox[{"loopMomentum", "[", "_", "]"}]}], "]"}]}], ")"}],
                     "&"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"sidx", ">", 
                   RowBox[{"Length", "[", "mom", "]"}]}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"discard", "[", "f", "]"}], "=", "True"}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"sidx", "=", "0"}], ";", "\[IndentingNewLine]", 
                   RowBox[{"Continue", "[", "]"}], ";"}]}], 
                 "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
                "\[IndentingNewLine]", 
                RowBox[{"mom", "=", 
                 RowBox[{"mom", "[", 
                  RowBox[{"[", "sidx", "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "If", " ", "the", " ", "momentum", " ", "is", " ", 
                   "already", " ", "routed", " ", "through"}], ",", " ", 
                  RowBox[{"ignore", " ", "it", " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"e", ".", "g", ".", " ", "p"}], " ", "in", " ", 
                    RowBox[{"Propagator", "[", 
                    RowBox[{
                    RowBox[{"{", "...", "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"-", "p"}], "+"}], "..."}], ",", " ", 
                    RowBox[{
                    RowBox[{"p", "+"}], "..."}]}], "}"}]}], "]"}]}], 
                    ")"}]}]}], "*)"}], "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"Not", "@", 
                   RowBox[{"MemberQ", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"Total", "[", 
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], 
                    "}"}], ",", "mom", ",", "Infinity"}], "]"}]}], ",", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"Continue", "[", "]"}], ";"}]}], 
                 "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
                "\[IndentingNewLine]", 
                RowBox[{"(*", 
                 RowBox[{
                  RowBox[{
                  "if", " ", "we", " ", "were", " ", "not", " ", "stopped"}], 
                  ",", " ", 
                  RowBox[{"we", " ", "got", " ", "it"}]}], "*)"}], 
                "\[IndentingNewLine]", 
                RowBox[{"Break", "[", "]"}], ";"}]}], "\[IndentingNewLine]", 
              "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{
               "The", " ", "only", " ", "other", " ", "possibility", " ", 
                "is", " ", "that", " ", "all", " ", "momenta", " ", "are", " ", 
                RowBox[{"external", ".", " ", "In"}], " ", "that", " ", 
                "case"}], ",", " ", 
               RowBox[{
               "we", " ", "do", " ", "nothing", " ", "but", " ", "check", " ", 
                RowBox[{"consistency", "."}]}]}], "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"f", "===", "\"\<NotFound\>\""}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Total", "@", 
                    RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}]}], "=!=",
                    "0"}], ",", 
                  RowBox[{
                   RowBox[{"Message", "[", 
                    RowBox[{
                    RowBox[{"FRoute", "::", "conservationFail"}], ",", 
                    "subObj"}], "]"}], ";", 
                   RowBox[{"Abort", "[", "]"}], ";"}]}], "]"}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"Continue", "[", "]"}]}]}], "\[IndentingNewLine]", 
              "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"momRepl", "=", 
              RowBox[{
               RowBox[{"Solve", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Total", "[", 
                   RowBox[{"subObj", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], 
                  "==", "0"}], ",", "mom"}], "]"}], "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"objects", "=", 
              RowBox[{"objects", "/.", "momRepl"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"ret", "=", 
              RowBox[{"ret", "/.", "momRepl"}]}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"FunKitDebug", "[", 
              RowBox[{
              "3", ",", "\"\<FRoute: routing a momentum as \>\"", ",", 
               "momRepl"}], "]"}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"Continue", "[", "]"}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", 
           RowBox[{"Length", "[", "objects", "]"}]}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Sanity", " ", "check", " ", "to", " ", "see", " ", "that", " ", "we",
          " ", "did", " ", "not", " ", "make", " ", "an", " ", "error"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"subObj", "=", 
           RowBox[{"objects", "[", 
            RowBox[{"[", "idx", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Skip", " ", "again", " ", "Fields", " ", "and", " ", "such"}], 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Length", "[", 
              RowBox[{"subObj", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], "<",
              "2"}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Check", " ", "the", " ", "conservation", " ", "of", " ", 
            "momentum", " ", "at", " ", "all", " ", "vertices"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Total", "[", 
              RowBox[{"subObj", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}], "=!=",
              "0"}], ",", 
            RowBox[{
             RowBox[{"Message", "[", 
              RowBox[{
               RowBox[{"FRoute", "::", "momentaFailed"}], ",", 
               RowBox[{"Total", "[", 
                RowBox[{"subObj", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "All", ",", "1"}], "]"}], "]"}], "]"}]}], 
              "]"}], ";", 
             RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";"}], 
         "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"idx", ",", "1", ",", 
           RowBox[{"Length", "[", "objects", "]"}]}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"replace", " ", "the", " ", 
          RowBox[{"loopMomenta", "[", "...", "]"}], " ", "by", " ", "l1"}], ",",
          " ", "l2", ",", " ", "..."}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"loopMomenta", "=", 
        RowBox[{
         RowBox[{"Cases", "[", 
          RowBox[{
           RowBox[{"objects", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", "2", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{"loopMomentum", "[", "_", "]"}], ",", "Infinity"}], "]"}], 
         "//", "DeleteDuplicates"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ret", "=", 
        RowBox[{"ret", "/.", 
         RowBox[{"Thread", "[", 
          RowBox[{"loopMomenta", "->", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Symbol", "[", 
              RowBox[{"$loopMomentumName", "<>", 
               RowBox[{"ToString", "[", "idx", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"idx", ",", "1", ",", 
               RowBox[{"Length", "[", "loopMomenta", "]"}]}], "}"}]}], 
            "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"loopMomenta", "=", 
        RowBox[{"loopMomenta", "/.", 
         RowBox[{"Thread", "[", 
          RowBox[{"loopMomenta", "->", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Symbol", "[", 
              RowBox[{"$loopMomentumName", "<>", 
               RowBox[{"ToString", "[", "idx", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"idx", ",", "1", ",", 
               RowBox[{"Length", "[", "loopMomenta", "]"}]}], "}"}]}], 
            "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Return", "[", 
        RowBox[{"<|", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"\"\<Expression\>\"", "->", 
           RowBox[{"FEq", "[", "ret", "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"\"\<ExternalIndices\>\"", "->", 
           RowBox[{"Sort", "@", "externalIndices"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<LoopMomenta\>\"", "->", 
           RowBox[{"Sort", "@", "loopMomenta"}]}]}], "\[IndentingNewLine]", 
         "|>"}], "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FRoute", "[", 
    RowBox[{"setup_", ",", "expr_FEq"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"results", ",", "ret", ",", "idx", ",", "subidx"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"results", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"FRoute", "[", 
          RowBox[{"setup", ",", "#"}], "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{"List", "@@", "expr"}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"results", "=", 
       RowBox[{"GatherBy", "[", 
        RowBox[{"results", ",", 
         RowBox[{
          RowBox[{"Length", "[", 
           RowBox[{"#", "[", "\"\<LoopMomenta\>\"", "]"}], "]"}], "&"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"results", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"<|", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"\"\<Expression\>\"", "->", 
             RowBox[{"FEq", "@@", 
              RowBox[{"#", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", 
                 RowBox[{"Key", "[", "\"\<Expression\>\"", "]"}]}], "]"}], 
               "]"}]}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"\"\<ExternalIndices\>\"", "->", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", 
                RowBox[{"Key", "[", "\"\<ExternalIndices\>\"", "]"}]}], "]"}],
               "]"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"\"\<LoopMomenta\>\"", "->", 
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", 
                RowBox[{"Key", "[", "\"\<LoopMomenta\>\"", "]"}]}], "]"}], 
              "]"}]}]}], "\[IndentingNewLine]", "|>"}], "&"}], ",", 
         "results"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"results", "=", 
       RowBox[{"Association", "@@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ToString", "[", 
              RowBox[{"Length", "[", 
               RowBox[{"#", "[", "\"\<LoopMomenta\>\"", "]"}], "]"}], "]"}], 
             "~~", "\"\<-Loop\>\""}], "->", "#"}], "&"}], ",", "results"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "results", "]"}], ";"}]}], "\[IndentingNewLine]",
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.951751348923993*^9, 3.951751439050681*^9}, {
   3.951755097993475*^9, 3.9517551433734303`*^9}, {3.9517551784935293`*^9, 
   3.951755296574402*^9}, {3.951758633518276*^9, 3.9517588180347013`*^9}, {
   3.951758851038365*^9, 3.951758874302556*^9}, {3.95175890520294*^9, 
   3.95175896195018*^9}, {3.9517592482197027`*^9, 3.951759311870655*^9}, {
   3.951759353680517*^9, 3.951759424262021*^9}, {3.9517594917602987`*^9, 
   3.951759494378818*^9}, {3.951804688526793*^9, 3.951804702403388*^9}, {
   3.9518047338052893`*^9, 3.95180473585146*^9}, {3.951804769595644*^9, 
   3.951804773803398*^9}, 3.951804843404299*^9, {3.951804890848074*^9, 
   3.951804996840213*^9}, {3.9518050301966677`*^9, 3.95180504507129*^9}, {
   3.9518051006122503`*^9, 3.951805156892478*^9}, {3.9518053825288887`*^9, 
   3.951805427164392*^9}, {3.951807773181683*^9, 3.9518079313259478`*^9}, {
   3.9518079636962643`*^9, 3.951807973896023*^9}, {3.9518082668569937`*^9, 
   3.951808476753015*^9}, {3.951808512453*^9, 3.9518087070013237`*^9}, {
   3.9518088340093727`*^9, 3.951808865509235*^9}, {3.951808943104828*^9, 
   3.951809020993392*^9}, {3.951809079053604*^9, 3.951809191345707*^9}, {
   3.951809287441435*^9, 3.951809368817621*^9}, 3.9518094299110823`*^9, {
   3.951809462494897*^9, 3.95180949000231*^9}, {3.951809523388411*^9, 
   3.951809661594295*^9}, {3.951809758793398*^9, 3.951809759669619*^9}, {
   3.9518098513779593`*^9, 3.9518098533575*^9}, {3.951809927761701*^9, 
   3.951809982057445*^9}, {3.951810019608322*^9, 3.9518101437656317`*^9}, {
   3.951810357993619*^9, 3.951810643372903*^9}, {3.951813007518557*^9, 
   3.951813083350391*^9}, {3.951813173174534*^9, 3.951813237702379*^9}, {
   3.9518134204529448`*^9, 3.951813661254634*^9}, {3.951813694925723*^9, 
   3.951813707466474*^9}, {3.951813740734716*^9, 3.95181379697073*^9}, 
   3.951813842434157*^9, {3.951813910733934*^9, 3.951813914322466*^9}, {
   3.951813946139722*^9, 3.9518140096017933`*^9}, {3.95181410249862*^9, 
   3.951814119094737*^9}, {3.951814154435281*^9, 3.951814258079308*^9}, {
   3.951814329534881*^9, 3.951814342834877*^9}, {3.951814386100335*^9, 
   3.951814389942725*^9}, {3.95181445074043*^9, 3.951814453182913*^9}, {
   3.951814515726446*^9, 3.951814579142827*^9}, {3.9518146834913397`*^9, 
   3.951814755978971*^9}, {3.9518148025277843`*^9, 3.951814825883478*^9}, {
   3.9518148575190477`*^9, 3.951814920155408*^9}, 3.951814962026309*^9, 
   3.9518155913949003`*^9, 3.9518156240221367`*^9, {3.951815683739657*^9, 
   3.951815684077384*^9}, {3.9518157500419483`*^9, 3.9518157700000362`*^9}, {
   3.951815954025556*^9, 3.951816084195631*^9}, {3.951816225663157*^9, 
   3.951816404527069*^9}, {3.951816475331403*^9, 3.9518165313086367`*^9}, {
   3.9518165812638693`*^9, 3.951816626431304*^9}, {3.951816821180819*^9, 
   3.951816847920456*^9}, {3.951816894627623*^9, 3.9518168960354357`*^9}, {
   3.951817267935977*^9, 3.951817401611945*^9}, {3.951817451727947*^9, 
   3.9518178674066343`*^9}, {3.9518180678490963`*^9, 3.951818194623975*^9}, {
   3.951818225844808*^9, 3.951818235895751*^9}, {3.95181828931117*^9, 
   3.95181832057162*^9}, {3.951818350849859*^9, 3.951818514884039*^9}, {
   3.951818577598249*^9, 3.951818650813181*^9}, {3.951818684591247*^9, 
   3.951818739267655*^9}, {3.95181880935528*^9, 3.951818813837883*^9}, {
   3.9518189707676888`*^9, 3.951818978336748*^9}, {3.951820061313384*^9, 
   3.951820078462379*^9}, 3.951820862574464*^9, {3.951823183665835*^9, 
   3.951823218482581*^9}, {3.951823328231336*^9, 3.951823442247957*^9}, {
   3.9518234764883213`*^9, 3.951823531610159*^9}, {3.951823669394766*^9, 
   3.951823772898859*^9}, {3.9518240179791527`*^9, 3.951824067675704*^9}, {
   3.951824230203885*^9, 3.95182423349088*^9}, {3.951824474350952*^9, 
   3.951824474633086*^9}, {3.951824603533162*^9, 3.951824807048462*^9}, {
   3.95182483737741*^9, 3.951825002868372*^9}, {3.951825041443684*^9, 
   3.951825052518309*^9}, {3.951825103092141*^9, 3.951825103412713*^9}, {
   3.951825301995453*^9, 3.9518253563400593`*^9}, {3.951825432060742*^9, 
   3.951825542734082*^9}, 3.9518296617404013`*^9, {3.951829716189186*^9, 
   3.951829726372357*^9}, {3.951829857984911*^9, 3.951829864159947*^9}, 
   3.951832760948634*^9, {3.9518379579912786`*^9, 3.9518379602825327`*^9}, {
   3.951841624832539*^9, 3.951841638259614*^9}, {3.9520809861144333`*^9, 
   3.952080987276782*^9}, 3.95226275536325*^9, {3.9534495221354723`*^9, 
   3.953449525536503*^9}, {3.953485273662936*^9, 3.95348539785182*^9}, {
   3.953485475187052*^9, 3.953485493846887*^9}, {3.953485620487557*^9, 
   3.953485634079095*^9}, {3.953485878459852*^9, 3.953485880291342*^9}, 
   3.953485912379489*^9, {3.953486100804147*^9, 3.953486104812524*^9}, {
   3.9534861533414297`*^9, 3.953486159107512*^9}, {3.9535203692412853`*^9, 
   3.953520379383713*^9}, {3.9535204141697817`*^9, 3.9535204333158197`*^9}, {
   3.953520486535966*^9, 3.953520561136078*^9}, {3.953520608616211*^9, 
   3.953520635001238*^9}, {3.953520695480179*^9, 3.953520710276103*^9}, {
   3.95352074501392*^9, 3.953520768004546*^9}, {3.9535209076157293`*^9, 
   3.953520959324852*^9}, {3.953521049916737*^9, 3.95352106648967*^9}, {
   3.9535211289340982`*^9, 3.9535211449044647`*^9}, {3.9535212122885437`*^9, 
   3.953521246741577*^9}, {3.9535213409808483`*^9, 3.953521347774206*^9}, {
   3.953521378257167*^9, 3.953521432748178*^9}, {3.953521465313436*^9, 
   3.9535215707846537`*^9}, {3.9535216499206867`*^9, 3.953521691416038*^9}, {
   3.9535236345985947`*^9, 3.9535236781212606`*^9}, {3.953526964844434*^9, 
   3.95352697998484*^9}, {3.953527015016876*^9, 3.953527077996668*^9}, {
   3.9535275656606913`*^9, 3.953527567408189*^9}, {3.953527668121016*^9, 
   3.953527788166484*^9}, {3.953530368012375*^9, 3.9535303698863573`*^9}, {
   3.9535304291867943`*^9, 3.95353044059568*^9}, {3.953530483031176*^9, 
   3.9535304967750587`*^9}, {3.9535305278251247`*^9, 3.95353057001882*^9}, {
   3.953530609704529*^9, 3.953530649058817*^9}, {3.953530710555277*^9, 
   3.953530712147091*^9}, {3.9535308530484743`*^9, 3.953530856142812*^9}, {
   3.9535309815905733`*^9, 3.9535310732037888`*^9}, {3.953531156824028*^9, 
   3.953531170287938*^9}, {3.953531204311306*^9, 3.953531262605255*^9}, {
   3.9535312972108173`*^9, 3.9535313126589947`*^9}, {3.9536104649171467`*^9, 
   3.953610499911004*^9}, {3.9536124004355383`*^9, 3.9536124061593513`*^9}, {
   3.9536126793764772`*^9, 3.953612686803454*^9}, {3.953614517721094*^9, 
   3.953614551011414*^9}, {3.953614595870376*^9, 3.953614661116095*^9}, 
   3.9536148630596743`*^9, {3.953614925253955*^9, 3.953614972307983*^9}, {
   3.95361515458961*^9, 3.9536152001212893`*^9}, {3.953615318684441*^9, 
   3.9536153438723087`*^9}, {3.953615490304469*^9, 3.9536155107927437`*^9}, {
   3.953615911386204*^9, 3.9536161236792316`*^9}, {3.953616259008471*^9, 
   3.9536163416684303`*^9}, 3.953616380902687*^9, {3.953616430331381*^9, 
   3.953616443849696*^9}, {3.9536165088501463`*^9, 3.953616511347459*^9}, {
   3.953616542871212*^9, 3.953616636469769*^9}, {3.953616687321747*^9, 
   3.953616734240678*^9}, {3.953616810657082*^9, 3.953616820893072*^9}, {
   3.9536168572651033`*^9, 3.953616858464691*^9}, {3.953616888521603*^9, 
   3.953616894625646*^9}, {3.953617405141163*^9, 3.9536177893290052`*^9}, 
   3.953647834689649*^9, {3.953692035662712*^9, 3.953692106743061*^9}, {
   3.953692155251202*^9, 3.9536921585869493`*^9}, {3.953692196418909*^9, 
   3.9536921985988407`*^9}, {3.9536922366519012`*^9, 3.953692244570874*^9}, {
   3.9536922799116573`*^9, 3.95369240140889*^9}, {3.953692470216022*^9, 
   3.9536924708319273`*^9}, {3.953692524327114*^9, 3.953692776191188*^9}, {
   3.9536976847625093`*^9, 3.9536977020961647`*^9}, 
   3.9563955355481586`*^9},ExpressionUUID->"cdeb8713-24bf-460c-884a-\
cc213810ba39"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"isLoopAssociation", "[", "expr_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "[", "expr", "]"}], "=!=", "Association"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"FreeQ", "[", 
         RowBox[{
          RowBox[{"Keys", "[", "expr", "]"}], ",", "\"\<Expression\>\""}], 
         "]"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"FreeQ", "[", 
         RowBox[{
          RowBox[{"Keys", "[", "expr", "]"}], ",", 
          "\"\<ExternalIndices\>\""}], "]"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"FreeQ", "[", 
         RowBox[{
          RowBox[{"Keys", "[", "expr", "]"}], ",", "\"\<LoopMomenta\>\""}], 
         "]"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "True", "]"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"isRoutedAssociation", "[", "expr_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "[", "expr", "]"}], "=!=", "Association"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "@", 
       RowBox[{"AllTrue", "[", 
        RowBox[{"expr", ",", "isLoopAssociation"}], "]"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.951834614676776*^9, 3.9518346959769793`*^9}, {
   3.951834870784346*^9, 3.951834873738884*^9}, {3.951835280872603*^9, 
   3.951835283287242*^9}, {3.953695278453631*^9, 3.953695354785406*^9}, 
   3.953695626441084*^9, {3.953697686916823*^9, 
   3.953697702881205*^9}},ExpressionUUID->"00de0eae-0500-4dd8-ab98-\
ad7243272911"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FUnroute", "[", 
     RowBox[{"setup_", ",", "assoc_Association"}], "]"}], "/;", 
    RowBox[{"isLoopAssociation", "[", "assoc", "]"}]}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Return", "@", 
       RowBox[{"FUnroute", "[", 
        RowBox[{
         RowBox[{"assoc", "[", "\"\<Expression\>\"", "]"}], "/.", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "->", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "&"}], ",", 
           RowBox[{"assoc", "[", "\"\<ExternalIndices\>\"", "]"}]}], "]"}]}], 
        "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FUnroute", "[", 
     RowBox[{"setup_", ",", "assoc_Association"}], "]"}], "/;", 
    RowBox[{"isRoutedAssociation", "[", "assoc", "]"}]}], ":=", 
   RowBox[{"FEq", "@@", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"FUnroute", "[", 
        RowBox[{"setup", ",", "#"}], "]"}], "&"}], "/@", 
      RowBox[{"(", 
       RowBox[{"List", "@@", "assoc"}], ")"}]}], ")"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FUnroute", "[", 
    RowBox[{"setup_", ",", "term_FEq"}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"FUnroute", "[", 
      RowBox[{"setup", ",", "#"}], "]"}], "&"}], "/@", "term"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FUnroute", "[", 
    RowBox[{"setup_", ",", "term_FTerm"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"fw", ",", "bw"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"fw", ",", "bw"}], "}"}], "=", 
       RowBox[{"GetSuperIndexTermTransformations", "[", 
        RowBox[{"setup", ",", "term"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"term", "//", "fw"}], "]"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.953449490091701*^9, 3.95344955216676*^9}, {
   3.953449592918777*^9, 3.953449737147065*^9}, {3.953449934939032*^9, 
   3.953449978331278*^9}, {3.9534500506194897`*^9, 3.953450108059379*^9}, {
   3.953454193591744*^9, 3.953454243363851*^9}, {3.9534542828519897`*^9, 
   3.9534542836637373`*^9}, {3.953454414288389*^9, 3.953454414636174*^9}, {
   3.953454448636635*^9, 3.953454460124205*^9}, {3.953531326921298*^9, 
   3.9535313291256847`*^9}, {3.953697498054185*^9, 3.953697544621428*^9}, {
   3.953697577442165*^9, 3.953697580857745*^9}, 3.9536976328755703`*^9, {
   3.953697687718705*^9, 
   3.953697703788844*^9}},ExpressionUUID->"c340c07d-b807-41f4-980c-\
ceb8b55933ad"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Identification of expressions", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}, {3.951633303953529*^9, 
  3.9516333082480516`*^9}},ExpressionUUID->"855a16af-fad8-4dc3-a58a-\
bba72dca9d84"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "Get", " ", "viable", " ", "starting", " ", "points", " ", "for", " ", "a",
     " ", "comparison", " ", "of", " ", "two", " ", "diagrams"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"StartPoints", "[", 
     RowBox[{"setup_", ",", "t1_FTerm", ",", "t2_FTerm"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "obj1", ",", "obj2", ",", "count", ",", "\[IndentingNewLine]", 
        "desired", ",", "sList", ",", "\[IndentingNewLine]", "match1", ",", 
        "match2", ",", "\[IndentingNewLine]", "cidx1", ",", "cidx2", ",", 
        "\[IndentingNewLine]", "doFields"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"doFields", "=", 
        RowBox[{"replFields", "[", "setup", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Get", " ", "all", " ", "sub"}], "-", 
         RowBox[{"objects", " ", "inside", " ", "the", " ", "terms"}]}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"obj1", "=", 
        RowBox[{
         RowBox[{"Reverse", "@", 
          RowBox[{"Sort", "@", 
           RowBox[{"ExtractObjectsWithIndex", "[", 
            RowBox[{"setup", ",", "t1"}], "]"}]}]}], "/.", "doFields"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"obj2", "=", 
        RowBox[{
         RowBox[{"Reverse", "@", 
          RowBox[{"Sort", "@", 
           RowBox[{"ExtractObjectsWithIndex", "[", 
            RowBox[{"setup", ",", "t2"}], "]"}]}]}], "/.", "doFields"}]}], ";",
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"If", " ", "the", " ", "objects", " ", 
          RowBox[{"(", 
           RowBox[{"with", " ", "field", " ", "content"}], ")"}], " ", "do", " ",
           "not", " ", "match"}], ",", " ", 
         RowBox[{"they", " ", "are", " ", "not", " ", 
          RowBox[{"identical", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"Sort", "@", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Head", "[", "#", "]"}], "[", 
               RowBox[{"Sort", "@", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}], ",", 
             "obj1"}], "]"}]}], "=!=", 
          RowBox[{"Sort", "@", 
           RowBox[{"Map", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Head", "[", "#", "]"}], "[", 
               RowBox[{"Sort", "@", 
                RowBox[{"#", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&"}], ",", 
             "obj2"}], "]"}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", 
          RowBox[{"{", 
           RowBox[{"False", ",", "Null", ",", "Null"}], "}"}], "]"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"cidx1", "=", 
        RowBox[{"GetClosedSuperIndices", "[", 
         RowBox[{"setup", ",", "t1"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"cidx2", "=", 
        RowBox[{"GetClosedSuperIndices", "[", 
         RowBox[{"setup", ",", "t2"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "cidx1", "]"}], "=!=", 
          RowBox[{"Length", "[", "cidx2", "]"}]}], ",", 
         RowBox[{"Return", "[", 
          RowBox[{"{", 
           RowBox[{"False", ",", "Null", ",", "Null"}], "}"}], "]"}]}], "]"}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"(*", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "cidx1", "]"}], ">", "0"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"obj1", "=", 
             RowBox[{"Select", "[", 
              RowBox[{"obj1", ",", 
               RowBox[{
                RowBox[{"ContainsAny", "[", 
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], ",", "cidx1"}], "]"}], 
                "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"obj1", "=", 
             RowBox[{"Select", "[", 
              RowBox[{"obj1", ",", 
               RowBox[{
                RowBox[{"ContainsAny", "[", 
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], ",", "cidx1"}], "]"}], 
                "&"}]}], "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
         ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Otherwise", ",", " ", 
         RowBox[{
         "we", " ", "check", " ", "which", " ", "object", " ", "is", " ", 
          "the", " ", "\"\<rarest\>\""}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"sList", "=", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Head", "[", "#", "]"}], "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], "&"}], ",", "obj1"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"count", "=", 
        RowBox[{"Counts", "[", "sList", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"desired", "=", 
        RowBox[{
         RowBox[{"Keys", "[", "count", "]"}], "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"PositionSmallest", "[", 
            RowBox[{"Values", "[", "count", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"match1", "=", 
        RowBox[{"Select", "[", 
         RowBox[{"obj1", ",", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"Head", "[", "#", "]"}], "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "]"}], "===", "desired"}], 
            ")"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"match2", "=", 
        RowBox[{"Select", "[", 
         RowBox[{"obj2", ",", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"Head", "[", "#", "]"}], "[", 
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "]"}], "===", "desired"}], 
            ")"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "return", " ", "all", " ", "possible", " ", "starting", " ", 
         "points"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{"True", ",", "match1", ",", "match2"}], "}"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9516333211534233`*^9, 3.951633531741598*^9}, {
   3.951633587620079*^9, 3.951633611792354*^9}, {3.951743485473118*^9, 
   3.951743731572995*^9}, {3.951743770166049*^9, 3.951743823313601*^9}, {
   3.951743859442398*^9, 3.9517438667697897`*^9}, {3.951743906362729*^9, 
   3.9517441748975077`*^9}, {3.951906079883687*^9, 3.951906475838584*^9}, {
   3.9519065773599377`*^9, 3.95190662163853*^9}, {3.951906660891856*^9, 
   3.951906965043215*^9}, {3.951907546404769*^9, 3.9519076247606783`*^9}, {
   3.9519077234444733`*^9, 3.9519077656164227`*^9}, {3.9519078204402742`*^9, 
   3.951907976655321*^9}, {3.9519090632887506`*^9, 3.951909240488873*^9}, {
   3.951909274692597*^9, 3.9519093453645277`*^9}, {3.9519093844007187`*^9, 
   3.9519095068688498`*^9}, {3.9519237808485527`*^9, 3.951923888906028*^9}, {
   3.951923957865979*^9, 3.95192420287046*^9}, {3.951924260622319*^9, 
   3.951924270751617*^9}, {3.9519252858294697`*^9, 3.951925389924634*^9}, {
   3.951925525667346*^9, 3.951925525939207*^9}, {3.951925559866441*^9, 
   3.951925661298108*^9}, {3.9519256976155367`*^9, 3.951925697726955*^9}, {
   3.951925762678039*^9, 3.9519257629100246`*^9}, {3.951925807511196*^9, 
   3.951925915804978*^9}, {3.951925955429325*^9, 3.951926000367688*^9}, {
   3.951926152135696*^9, 3.951926499034038*^9}, {3.951926542087852*^9, 
   3.951926678592882*^9}, {3.9519270096064672`*^9, 3.951927197536558*^9}, {
   3.95192870612739*^9, 3.951928809904442*^9}, {3.95196811847834*^9, 
   3.951968230198434*^9}, {3.951968362526638*^9, 3.95196838613076*^9}, {
   3.951968454333304*^9, 3.951968499283574*^9}, {3.951968542385379*^9, 
   3.9519686259758244`*^9}, {3.9519686783928337`*^9, 
   3.9519687294729652`*^9}, {3.951968814121481*^9, 3.9519688278847017`*^9}, {
   3.951968859350655*^9, 3.9519688686852303`*^9}, {3.951968906422058*^9, 
   3.951968936993037*^9}, {3.95196898213704*^9, 3.951969049785241*^9}, {
   3.951969096389967*^9, 3.9519691570612783`*^9}, {3.951969225265443*^9, 
   3.951969286449272*^9}, {3.951969336267407*^9, 3.9519693406879463`*^9}, {
   3.951969392133569*^9, 3.9519694075093937`*^9}, {3.951969501660769*^9, 
   3.9519695195425043`*^9}, {3.95196960505717*^9, 3.9519696057932987`*^9}, {
   3.951969962262328*^9, 3.951970002789999*^9}, {3.951970035871889*^9, 
   3.951970110743425*^9}, {3.951970148283924*^9, 3.951970152658205*^9}, {
   3.951970188481698*^9, 3.951970189921488*^9}, {3.951970259617659*^9, 
   3.951970279746674*^9}, {3.951970332355595*^9, 3.95197033834164*^9}, {
   3.9519703838219433`*^9, 3.951970461569515*^9}, {3.9519705736460648`*^9, 
   3.951971019411439*^9}, {3.9519710812080193`*^9, 3.951971097234104*^9}, {
   3.9519711277368517`*^9, 3.951971138545607*^9}, 3.951971200643173*^9, {
   3.951971443210004*^9, 3.951971612169821*^9}, {3.951972406262732*^9, 
   3.9519724097642*^9}, {3.951976371454915*^9, 3.951976373130065*^9}, {
   3.951983776483045*^9, 3.951983777598236*^9}, {3.951983820000001*^9, 
   3.9519838927820473`*^9}, {3.951984025713551*^9, 3.951984115736826*^9}, {
   3.951988595355195*^9, 3.951988652472184*^9}, {3.951989923798073*^9, 
   3.951989931500515*^9}, {3.951989996540024*^9, 3.951990009498762*^9}, {
   3.95199008811298*^9, 3.951990091076264*^9}, {3.951990156072295*^9, 
   3.951990160368146*^9}, 3.951990521700841*^9, {3.952055465925704*^9, 
   3.95205554037192*^9}, {3.9520555905850277`*^9, 3.9520557111277943`*^9}, {
   3.952055762387545*^9, 3.952055786947954*^9}, {3.9520558341528263`*^9, 
   3.952055842584465*^9}, {3.9520558881485033`*^9, 3.9520559623408947`*^9}, {
   3.952055998952303*^9, 3.952056114223958*^9}, {3.952056167596673*^9, 
   3.952056168835868*^9}, {3.952056242547987*^9, 3.952056318810377*^9}, {
   3.952056501777038*^9, 3.952056548781599*^9}, {3.952056660900345*^9, 
   3.9520566927371063`*^9}, {3.952056815206457*^9, 3.952056928126857*^9}, {
   3.9520569613895283`*^9, 3.952056990777802*^9}, {3.9520581039811068`*^9, 
   3.952058104776422*^9}, {3.952058154636284*^9, 3.952058155687317*^9}, {
   3.95215218884956*^9, 3.952152203993988*^9}, {3.9521522547128887`*^9, 
   3.95215227528966*^9}, {3.952262759402645*^9, 3.952262761078068*^9}, {
   3.9535262041893587`*^9, 3.953526214677554*^9}, {3.9535262478098907`*^9, 
   3.953526427581518*^9}, 
   3.953526470959364*^9},ExpressionUUID->"475d9bdd-2660-454f-a06f-\
4505f5c4aa8c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "Find", " ", "all", " ", "objects", " ", "following", " ", "the", " ", 
    "closed", " ", "indices", " ", "attached", " ", "to", " ", "the", " ", 
    "object", " ", "curPos"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"IterateDiagram", "[", 
     RowBox[{
     "setup_Association", ",", "allObj_", ",", "closedIndices_", ",", 
      "openIndices_", ",", "curPos_", ",", "entryIdx_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"otherIndices", ",", "followObjects", ",", "i"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FunKitDebug", "[", 
        RowBox[{"4", ",", "\"\<Inspecting: \>\"", ",", "curPos"}], "]"}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "All", " ", "indices", " ", "except", " ", "the", " ", "one", " ", 
         "we", " ", "entered", " ", "with"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"otherIndices", "=", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{
          RowBox[{"makePosIdx", "/@", 
           RowBox[{"curPos", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], ",", "entryIdx"}], "]"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"otherIndices", "=", 
        RowBox[{"Intersection", "[", 
         RowBox[{"otherIndices", ",", "closedIndices"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"FunKitDebug", "[", 
        RowBox[{
        "4", ",", "\"\<Found outgoing indices: \>\"", ",", "otherIndices"}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "all", " ", "objects", " ", "containing", " ", "the", " ", 
         "otherIndices"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"followObjects", "=", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"DeleteCases", "[", 
              RowBox[{"allObj", ",", "curPos"}], "]"}], ",", 
             RowBox[{
              RowBox[{"MemberQ", "[", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], ",", 
                RowBox[{"otherIndices", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], ",", "Infinity"}], "]"}], 
              "&"}]}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "otherIndices", "]"}]}], "}"}]}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"FunKitDebug", "[", 
        RowBox[{
        "3", ",", "\"\<Found followObjects: \>\"", ",", "followObjects"}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{"otherIndices", ",", "followObjects"}], "}"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.9520581635631323`*^9, {3.9527601918821487`*^9, 3.9527603736497307`*^9}, {
   3.95276041543505*^9, 3.952760444035327*^9}, {3.953565732411371*^9, 
   3.953565784995468*^9}, {3.9538691100041656`*^9, 3.953869111522743*^9}, {
   3.956334592117083*^9, 3.956334621753549*^9}, {3.956371872563686*^9, 
   3.956371884040917*^9}, 
   3.9563729521892567`*^9},ExpressionUUID->"f2ce13a1-b99d-4d24-ba77-\
209c21a7becd"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"maximum", " ", "accepted", " ", "loop", " ", 
    RowBox[{"length", "."}]}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"$MaxIterLoop", "=", "100"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"TermsEqualAndSum", "::", "exceededLoopLimit"}], "=", 
     RowBox[{"\"\<Exceeded the maximum allowed length of a loop! (\>\"", "<>", 
      RowBox[{"ToString", "[", "$MaxIterLoop", "]"}], "<>", "\"\<)\>\""}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"TermsEqualAndSum", "::", "branchFailure"}], 
     "=", "\"\<Arrived at unhandled branch point\>\""}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"TermsEqualAndSum", "[", 
      RowBox[{
      "setup_", ",", "t1_", ",", "t2_", ",", "\[IndentingNewLine]", 
       "MallObjt1_", ",", "cidxt1_", ",", "oidxt1_", ",", "Mmemory1_", ",", 
       "entry1_", ",", "\[IndentingNewLine]", "MallObjt2_", ",", "cidxt2_", ",",
        "oidxt2_", ",", "Mmemory2_", ",", "entry2_", ",", "Msign2_"}], 
      "\[IndentingNewLine]", "]"}], ":=", 
     RowBox[{"Module", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"allObjt1", "=", "MallObjt1"}], ",", "curIdx1", ",", 
         "curPos1", ",", "nextInd1", ",", "nextPos1", ",", 
         RowBox[{"memory1", "=", "Mmemory1"}], ",", "assocFields1", ",", 
         "\[IndentingNewLine]", 
         RowBox[{"allObjt2", "=", "MallObjt2"}], ",", "curIdx2", ",", 
         "curPos2", ",", "nextInd2", ",", "nextPos2", ",", 
         RowBox[{"memory2", "=", "Mmemory2"}], ",", "assocFields2", ",", 
         RowBox[{"sign2", "=", "Msign2"}], ",", "\[IndentingNewLine]", 
         RowBox[{"iter", "=", "1"}], ",", "idx", ",", "jdx", ",", 
         "viableBranches", ",", "branchSign", ",", "branchItRepl", ",", 
         "branchObj", ",", "\[IndentingNewLine]", "temp1", ",", "temp2"}], 
        "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"FunKitDebug", "[", 
         RowBox[{"3", ",", "\"\<Following along a chain of indices.\>\""}], 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"curIdx1", "=", 
         RowBox[{"makePosIdx", "@", "entry1"}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"curIdx2", "=", 
         RowBox[{"makePosIdx", "@", "entry2"}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"curPos1", "=", 
         RowBox[{"memory1", "[", 
          RowBox[{"[", 
           RowBox[{"-", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"curPos2", "=", 
         RowBox[{"memory2", "[", 
          RowBox[{"[", 
           RowBox[{"-", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{"iter", "<", "$MaxIterLoop"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
           "Take", " ", "a", " ", "single", " ", "step", " ", "forward", " ", 
            "in", " ", "the", " ", "terms"}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"nextInd1", ",", "nextPos1"}], "}"}], "=", 
            RowBox[{"IterateDiagram", "[", 
             RowBox[{
             "setup", ",", "allObjt1", ",", "cidxt1", ",", "oidxt1", ",", 
              "curPos1", ",", "curIdx1"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"nextInd2", ",", "nextPos2"}], "}"}], "=", 
            RowBox[{"IterateDiagram", "[", 
             RowBox[{
             "setup", ",", "allObjt2", ",", "cidxt2", ",", "oidxt2", ",", 
              "curPos2", ",", "curIdx2"}], "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"If", " ", "the", " ", 
              RowBox[{"(", 
               RowBox[{"set", " ", "of"}], ")"}], " ", "next", " ", "object", 
              
              RowBox[{"(", "s", ")"}], " ", "is", " ", "different", " ", 
              "for", " ", "1", " ", "and", " ", "2"}], ",", " ", 
             RowBox[{"we", " ", "can", " ", "immediately", " ", 
              RowBox[{"abort", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Sort", "@", 
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Head", "[", "#", "]"}], "[", 
                   RowBox[{"Sort", "[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], "&"}], ",", 
                 "nextPos1"}], "]"}]}], "=!=", 
              RowBox[{"Sort", "@", 
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Head", "[", "#", "]"}], "[", 
                   RowBox[{"Sort", "[", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], "&"}], ",", 
                 "nextPos2"}], "]"}]}]}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"FunKitDebug", "[", 
               RowBox[{
               "3", ",", "\"\<FAILURE ------------ Heads do not match: \>\"", 
                ",", "nextPos1", ",", "\"\<, \>\"", ",", "nextPos2"}], "]"}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{"Return", "[", 
               RowBox[{"{", 
                RowBox[{"False", ",", "allObjt2"}], "}"}], "]"}]}]}], 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
            "Check", " ", "if", " ", "the", " ", "external", " ", "indices", " ",
              "in", " ", "the", " ", "current", " ", "object", " ", "match"}],
             "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Intersection", "[", 
               RowBox[{"oidxt1", ",", 
                RowBox[{"makePosIdx", "/@", 
                 RowBox[{"(", 
                  RowBox[{"curPos1", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], ")"}]}]}], "]"}], "=!=", 
              RowBox[{"Intersection", "[", 
               RowBox[{"oidxt2", ",", 
                RowBox[{"makePosIdx", "/@", 
                 RowBox[{"(", 
                  RowBox[{"curPos2", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], ")"}]}]}], "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"FunKitDebug", "[", 
               RowBox[{
               "3", ",", "\"\<FAILURE ------------ Current open indices \
disagree: \>\"", ",", 
                RowBox[{"Intersection", "[", 
                 RowBox[{"oidxt1", ",", 
                  RowBox[{"makePosIdx", "/@", 
                   RowBox[{"(", 
                    RowBox[{"curPos1", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ")"}]}]}], "]"}], 
                ",", "\"\<, \>\"", ",", 
                RowBox[{"Intersection", "[", 
                 RowBox[{"oidxt2", ",", 
                  RowBox[{"makePosIdx", "/@", 
                   RowBox[{"(", 
                    RowBox[{"curPos2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ")"}]}]}], "]"}]}], "]"}],
               ";", "\[IndentingNewLine]", 
              RowBox[{"Return", "[", 
               RowBox[{"{", 
                RowBox[{"False", ",", "allObjt2"}], "}"}], "]"}]}]}], "]"}], ";",
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"FunKitDebug", "[", 
            RowBox[{
            "3", ",", "\"\<Next objects along the chain: \>\"", ",", 
             "nextPos1", ",", "\"\<, \>\"", ",", "nextPos2"}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"FunKitDebug", "[", 
            RowBox[{
            "3", ",", "\"\<Entering through: \>\"", ",", "nextInd1", 
             ",", "\"\<, \>\"", ",", "nextInd2"}], "]"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"Case", " ", "1"}], ":", " ", 
             RowBox[{
             "There", " ", "is", " ", "only", " ", "a", " ", "single", " ", 
              "object", " ", "following"}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "nextInd1", "]"}], "===", "1"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"FunKitDebug", "[", 
               RowBox[{"3", ",", "\"\<Following the index chain.\>\""}], 
               "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
               "Check", " ", "if", " ", "the", " ", "open", " ", "indices", " ",
                 "aggree"}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Sort", "@", 
                  RowBox[{"Intersection", "[", 
                   RowBox[{"oidxt1", ",", 
                    RowBox[{"makePosIdx", "/@", 
                    RowBox[{"nextPos1", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}], "]"}]}], "=!=", 
                 RowBox[{"Sort", "@", 
                  RowBox[{"Intersection", "[", 
                   RowBox[{"oidxt2", ",", 
                    RowBox[{"makePosIdx", "/@", 
                    RowBox[{"nextPos2", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}], "]"}]}]}], ",",
                 "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"FunKitDebug", "[", 
                  RowBox[{
                  "3", ",", "\"\<FAILURE ------------ Next open indices \
disagree.\>\"", ",", 
                   RowBox[{"Sort", "@", 
                    RowBox[{"Intersection", "[", 
                    RowBox[{"oidxt1", ",", 
                    RowBox[{"makePosIdx", "/@", 
                    RowBox[{"nextPos1", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}], "]"}]}], 
                   ",", "\"\<, \>\"", ",", 
                   RowBox[{"Sort", "@", 
                    RowBox[{"Intersection", "[", 
                    RowBox[{"oidxt2", ",", 
                    RowBox[{"makePosIdx", "/@", 
                    RowBox[{"nextPos2", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}], "]"}]}]}], 
                  "]"}], ";", "\[IndentingNewLine]", 
                 RowBox[{"Return", "[", 
                  RowBox[{"{", 
                   RowBox[{"False", ",", "allObjt2"}], "}"}], "]"}]}]}], 
               "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"fix", " ", "the", " ", "current", " ", "object"}], 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"temp1", ",", "temp2"}], "}"}], "=", 
               RowBox[{"RearrangeFields", "[", 
                RowBox[{"setup", ",", "curPos1", ",", "curPos2", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"nextInd1", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                   RowBox[{"nextInd2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"sign2", "=", 
               RowBox[{"sign2", "*", "temp1"}]}], ";", "\[IndentingNewLine]", 
              
              RowBox[{"allObjt2", "=", 
               RowBox[{"allObjt2", "/.", 
                RowBox[{"curPos2", "->", "temp2"}]}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"memory2", "=", 
               RowBox[{"memory2", "/.", 
                RowBox[{"curPos2", "->", "temp2"}]}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"curPos2", "=", "temp2"}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"fix", " ", "the", " ", "next", " ", "object"}], 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"temp1", ",", "temp2"}], "}"}], "=", 
               RowBox[{"RearrangeFields", "[", 
                RowBox[{"setup", ",", 
                 RowBox[{"nextPos1", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], ",", 
                 RowBox[{"nextPos2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"nextInd1", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                   RowBox[{"nextInd2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"sign2", "=", 
               RowBox[{"sign2", "*", "temp1"}]}], ";", "\[IndentingNewLine]", 
              
              RowBox[{"allObjt2", "=", 
               RowBox[{"allObjt2", "/.", 
                RowBox[{
                 RowBox[{"nextPos2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "->", "temp2"}]}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"memory2", "=", 
               RowBox[{"memory2", "/.", 
                RowBox[{
                 RowBox[{"nextPos2", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "->", "temp2"}]}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"nextPos2", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "=", "temp2"}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
               "Check", " ", "if", " ", "we", " ", "closed", " ", "a", " ", 
                "loop"}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"FirstPosition", "[", 
                   RowBox[{"memory1", ",", 
                    RowBox[{"nextPos1", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "===", 
                  RowBox[{"FirstPosition", "[", 
                   RowBox[{"memory2", ",", 
                    RowBox[{"nextPos2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], "&&", 
                 RowBox[{"NumericQ", "[", 
                  RowBox[{
                   RowBox[{"FirstPosition", "[", 
                    RowBox[{"memory1", ",", 
                    RowBox[{"nextPos1", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "[", 
                   RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"FunKitDebug", "[", 
                  RowBox[{
                  "3", ",", "\"\<SUCCESS ------------ Closed a loop.\>\""}], 
                  "]"}], ";", "\[IndentingNewLine]", 
                 RowBox[{"Return", "[", 
                  RowBox[{"{", 
                   RowBox[{"sign2", ",", "allObjt2"}], "}"}], "]"}]}]}], 
               "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{"Closed", " ", "one", " ", "loop"}], ",", " ", 
                RowBox[{"but", " ", "not", " ", "the", " ", "other"}]}], 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"FirstPosition", "[", 
                  RowBox[{"memory1", ",", 
                   RowBox[{"nextPos1", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "=!=", 
                 RowBox[{"FirstPosition", "[", 
                  RowBox[{"memory2", ",", 
                   RowBox[{"nextPos2", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"FunKitDebug", "[", 
                  RowBox[{
                  "3", ",", "\"\<FAILURE ------------ Closed only one loop.\>\
\""}], "]"}], ";", "\[IndentingNewLine]", 
                 RowBox[{"Return", "[", 
                  RowBox[{"{", 
                   RowBox[{"False", ",", "allObjt2"}], "}"}], "]"}]}]}], 
               "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"step", " ", "forward"}], "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{"curIdx1", "=", 
               RowBox[{"nextInd1", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ";", 
              RowBox[{"curPos1", "=", 
               RowBox[{"nextPos1", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
              
              RowBox[{"curIdx2", "=", 
               RowBox[{"nextInd2", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ";", 
              RowBox[{"curPos2", "=", 
               RowBox[{"nextPos2", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{"update", " ", "the", " ", "memory"}], "*)"}], 
              "\[IndentingNewLine]", 
              RowBox[{"AppendTo", "[", 
               RowBox[{"memory1", ",", "curPos1"}], "]"}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"AppendTo", "[", 
               RowBox[{"memory2", ",", "curPos2"}], "]"}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"iter", "++"}], ";", "\[IndentingNewLine]", 
              RowBox[{"Continue", "[", "]"}], ";"}]}], "\[IndentingNewLine]", 
            "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"Case", " ", "2"}], ":", " ", 
             RowBox[{"End", " ", "of", " ", "the", " ", 
              RowBox[{"line", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "nextInd1", "]"}], "===", "0"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"FunKitDebug", "[", 
               RowBox[{
               "4", ",", "\"\<Finished an index chain in (\>\"", ",", 
                "curPos1", ",", "\"\<, \>\"", ",", "curPos2", 
                ",", "\"\<)\>\""}], "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
               "We", " ", "need", " ", "to", " ", "check", " ", "if", " ", 
                "both", " ", "expressions", " ", "are", " ", "with", " ", 
                "FDOps"}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Head", "@", "curPos1"}], "===", "Field"}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"temp1", "=", 
                  RowBox[{"Cases", "[", 
                   RowBox[{"t1", ",", 
                    RowBox[{"FDOp", "[", 
                    RowBox[{
                    RowBox[{"curPos1", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], "[", 
                    RowBox[{"curPos1", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ",", 
                    "Infinity"}], "]"}]}], ";", "\[IndentingNewLine]", 
                 RowBox[{"temp2", "=", 
                  RowBox[{"Cases", "[", 
                   RowBox[{"t2", ",", 
                    RowBox[{"FDOp", "[", 
                    RowBox[{
                    RowBox[{"curPos2", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], "[", 
                    RowBox[{"curPos2", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "1"}], "]"}], "]"}], "]"}], "]"}], ",", 
                    "Infinity"}], "]"}]}], ";", "\[IndentingNewLine]", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "[", "temp1", "]"}], "=!=", 
                    RowBox[{"Length", "[", "temp2", "]"}]}], ",", 
                   "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"FunKitDebug", "[", 
                    RowBox[{
                    "3", ",", "\"\<FAILURE ------------ Number of FDOps is \
different.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"Return", "[", 
                    RowBox[{"{", 
                    RowBox[{"False", ",", "allObjt2"}], "}"}], "]"}]}]}], 
                  "\[IndentingNewLine]", "]"}], ";"}]}], 
               "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"FunKitDebug", "[", 
               RowBox[{
               "3", ",", "\"\<SUCCESS ------------ Index chain ended with \
equality.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"Return", "[", 
               RowBox[{"{", 
                RowBox[{"sign2", ",", "allObjt2"}], "}"}], "]"}]}]}], "]"}], ";",
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"Case", " ", "3"}], ":", " ", 
             RowBox[{"Branching", " ", 
              RowBox[{"point", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Length", "[", "nextInd1", "]"}], ">", "1"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"FunKitDebug", "[", 
               RowBox[{"3", ",", "\"\<Index chain is branching.\>\""}], "]"}],
               ";", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{
                "We", " ", "need", " ", "to", " ", "build", " ", "all", " ", 
                 "possible", " ", "combinations", " ", "between", " ", "the", 
                 " ", "\"\<next\>\"", " ", "indices", " ", "and", " ", 
                 "follow", " ", "these", " ", "separately"}], ",", " ", 
                RowBox[{"until", " ", "one", " ", "of", " ", "them", " ", 
                 RowBox[{"fits", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"assocFields1", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{"curPos1", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", 
                    RowBox[{
                    RowBox[{"FirstPosition", "[", 
                    RowBox[{
                    RowBox[{"curPos1", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "#"}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}], "&"}], "/@",
                 "nextInd1"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"assocFields2", "=", 
               RowBox[{
                RowBox[{
                 RowBox[{"curPos2", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", 
                    RowBox[{
                    RowBox[{"FirstPosition", "[", 
                    RowBox[{
                    RowBox[{"curPos2", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "#"}], "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "]"}], "&"}], "/@",
                 "nextInd2"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"viableBranches", "=", 
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Transpose", "[", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"Transpose", "@", 
                    RowBox[{"{", 
                    RowBox[{
                    "nextInd1", ",", "assocFields1", ",", "nextPos1"}], 
                    "}"}]}], ",", "#"}], "}"}], "]"}], "&"}], ",", 
                 RowBox[{"Permutations", "[", 
                  RowBox[{"Transpose", "@", 
                   RowBox[{"{", 
                    RowBox[{
                    "nextInd2", ",", "assocFields2", ",", "nextPos2"}], 
                    "}"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"viableBranches", "=", 
               RowBox[{"Select", "[", 
                RowBox[{"viableBranches", ",", 
                 RowBox[{
                  RowBox[{"AllTrue", "[", 
                   RowBox[{"#", ",", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "2"}], "]"}], "]"}], "===", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", 
                    RowBox[{"2", ",", "2"}], "]"}], "]"}]}], ")"}], "&"}]}], 
                   "]"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"FunKitDebug", "[", 
               RowBox[{
               "4", ",", "\"\<Viable Branches: \>\"", ",", "viableBranches"}],
                "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"For", "[", 
               RowBox[{
                RowBox[{"idx", "=", "1"}], ",", 
                RowBox[{"idx", "<=", 
                 RowBox[{"Length", "[", "viableBranches", "]"}]}], ",", 
                RowBox[{"idx", "++"}], ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"branchSign", "=", "sign2"}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"branchObj", "=", "allObjt2"}], ";", 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", 
                 RowBox[{"Do", "[", "\[IndentingNewLine]", 
                  RowBox[{"(*", 
                   RowBox[{
                   "Fix", " ", "the", " ", "outgoing", " ", "objects"}], 
                   "*)"}], "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"branchSign", ",", "branchItRepl"}], "}"}], "=", 
                    RowBox[{"RearrangeFields", "[", 
                    RowBox[{"setup", ",", "curPos1", ",", "curPos2", ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "All", ",", "1"}], "]"}], 
                    "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{
                    "Fix", " ", "the", " ", "incoming", " ", "objects"}], 
                    "*)"}], "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"temp1", ",", "temp2"}], "}"}], "=", 
                    RowBox[{"RearrangeFields", "[", 
                    RowBox[{"setup", ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "1", ",", "3"}], "]"}], 
                    "]"}], ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "2", ",", "3"}], "]"}], 
                    "]"}], ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "All", ",", "1"}], "]"}], 
                    "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
                    "\[IndentingNewLine]", 
                    RowBox[{"branchSign", "=", 
                    RowBox[{"temp1", "*", "branchSign"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"branchObj", "=", 
                    RowBox[{"branchObj", "/.", 
                    RowBox[{"curPos2", "->", "branchItRepl"}]}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"branchObj", "=", 
                    RowBox[{"branchObj", "/.", 
                    RowBox[{
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "2", ",", "3"}], "]"}], 
                    "]"}], "->", "temp2"}]}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "2", ",", "3"}], "]"}], 
                    "]"}], "=", "temp2"}], ";", "\[IndentingNewLine]", 
                    "\[IndentingNewLine]", 
                    RowBox[{"FunKitDebug", "[", 
                    RowBox[{
                    "4", ",", "\"\<Branching at \>\"", ",", "branchObj"}], 
                    "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"branchSign", ",", "branchObj"}], "}"}], "=", 
                    RowBox[{"TermsEqualAndSum", "[", 
                    RowBox[{
                    "setup", ",", "t1", ",", "t2", ",", "\[IndentingNewLine]",
                     "allObjt1", ",", "cidxt1", ",", "oidxt1", ",", 
                    RowBox[{"Append", "[", 
                    RowBox[{"memory1", ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "1", ",", "3"}], "]"}], 
                    "]"}]}], "]"}], ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "1", ",", "1"}], "]"}], 
                    "]"}], ",", "\[IndentingNewLine]", "branchObj", ",", 
                    "cidxt2", ",", "oidxt2", ",", 
                    RowBox[{"Append", "[", 
                    RowBox[{
                    RowBox[{"memory2", "/.", 
                    RowBox[{"curPos2", "->", "branchItRepl"}]}], ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "2", ",", "3"}], "]"}], 
                    "]"}]}], "]"}], ",", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", 
                    RowBox[{"idx", ",", "jdx", ",", "2", ",", "1"}], "]"}], 
                    "]"}], ",", "branchSign"}], "\[IndentingNewLine]", 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"branchSign", "===", "False"}], ",", 
                    RowBox[{"Break", "[", "]"}]}], "]"}], ";"}], 
                   "\[IndentingNewLine]", ",", 
                   RowBox[{"{", 
                    RowBox[{"jdx", ",", "1", ",", 
                    RowBox[{"Length", "[", 
                    RowBox[{"viableBranches", "[", 
                    RowBox[{"[", "idx", "]"}], "]"}], "]"}]}], "}"}]}], 
                  "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{"branchSign", "===", "False"}], ",", 
                   RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"FunKitDebug", "[", 
                  RowBox[{
                  "3", ",", "\"\<SUCCESS ------------ Branch \>\"", ",", 
                   "idx", ",", "\"\< succeeded, branchSign is \>\"", ",", 
                   "branchSign"}], "]"}], ";", "\[IndentingNewLine]", 
                 RowBox[{"Return", "[", 
                  RowBox[{"{", 
                   RowBox[{"branchSign", ",", "branchObj"}], "}"}], "]"}], 
                 ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"FunKitDebug", "[", 
               RowBox[{
               "3", ",", "\"\<FAILURE ------------ Branch failed.\>\""}], 
               "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"Return", "[", 
               RowBox[{"{", 
                RowBox[{"False", ",", "allObjt2"}], "}"}], "]"}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"Nothing", " ", "should", " ", "lead", " ", "here"}], 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"Message", "[", 
            RowBox[{"TermsEqualAndSum", "::", "branchFailure"}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Abort", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}],
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Nothing", " ", "should", " ", "lead", " ", "here"}], "*)"}],
         "\[IndentingNewLine]", 
        RowBox[{"Message", "[", 
         RowBox[{"TermsEqualAndSum", "::", "exceededLoopLimit"}], "]"}], ";", 
        
        RowBox[{"Abort", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
    ";"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.952058161123794*^9, 3.95205818223645*^9}, {
   3.9520582321525106`*^9, 3.9520582927160597`*^9}, 3.952058351689789*^9, {
   3.952151842191654*^9, 3.95215186500392*^9}, {3.952151900228372*^9, 
   3.952151949432001*^9}, {3.95215199890835*^9, 3.95215202208425*^9}, {
   3.952152280745632*^9, 3.9521523152757196`*^9}, {3.952759804155055*^9, 
   3.952760001734425*^9}, {3.952760083428009*^9, 3.952760167251432*^9}, {
   3.952760491764105*^9, 3.952760509011883*^9}, {3.952760551717412*^9, 
   3.952760578904114*^9}, {3.952760788655609*^9, 3.952761039252328*^9}, {
   3.952761185364995*^9, 3.952761247604404*^9}, {3.953464678303563*^9, 
   3.953464757540038*^9}, {3.953554009903615*^9, 3.95355402372296*^9}, {
   3.95355419258608*^9, 3.953554282083694*^9}, {3.953565569454893*^9, 
   3.953565569640213*^9}, {3.953565613070826*^9, 3.953565672307972*^9}, {
   3.953565864529079*^9, 3.953565880732627*^9}, 3.953567323636249*^9, {
   3.953567362775832*^9, 3.953567392919817*^9}, {3.953567495603775*^9, 
   3.9535675429600487`*^9}, {3.9535676524642477`*^9, 3.953567657151966*^9}, {
   3.953567742335935*^9, 3.953567779043895*^9}, {3.953567811322298*^9, 
   3.953567950164144*^9}, 3.95356798586112*^9, {3.9536269415318336`*^9, 
   3.953627027178574*^9}, {3.953627065423497*^9, 3.953627193062902*^9}, {
   3.953627223155179*^9, 3.953627253097632*^9}, 3.9536976893517838`*^9, {
   3.953868947054886*^9, 3.953869007206731*^9}, {3.95386905497961*^9, 
   3.9538690638785458`*^9}, {3.953869123947124*^9, 3.9538691717585087`*^9}, {
   3.9538692044484673`*^9, 3.953869237978573*^9}, {3.953873484957862*^9, 
   3.953873494456601*^9}, {3.9538736559696083`*^9, 3.953873656273069*^9}, 
   3.9538737843182783`*^9, {3.9538738756858473`*^9, 3.95387388851294*^9}, {
   3.953874351921323*^9, 3.953874421644244*^9}, {3.953874497081808*^9, 
   3.9538745333097153`*^9}, 3.953875416227294*^9, 3.9538755052299833`*^9, {
   3.9538759382722387`*^9, 3.9538759461774473`*^9}, {3.953875984438957*^9, 
   3.9538759961080513`*^9}, {3.953876102170047*^9, 3.953876125049461*^9}, {
   3.953876259738317*^9, 3.953876313453524*^9}, {3.953913861455971*^9, 
   3.9539138622518187`*^9}, {3.956334896755249*^9, 3.956334918965846*^9}, 
   3.956334988147544*^9, {3.9563350684189034`*^9, 3.956335095060135*^9}, {
   3.956335198249436*^9, 3.956335230662243*^9}, {3.9563353173441277`*^9, 
   3.956335360474247*^9}, {3.956335474624716*^9, 3.956335560862793*^9}, {
   3.9563357468151693`*^9, 3.9563357821297007`*^9}, {3.956335959778453*^9, 
   3.956335964003263*^9}, {3.956336030468375*^9, 3.956336031664877*^9}, {
   3.956371568507184*^9, 3.956371582177581*^9}, {3.956371938027226*^9, 
   3.9563719906202908`*^9}, {3.95637225889345*^9, 3.956372267495289*^9}, {
   3.95637229994063*^9, 3.956372306677216*^9}, {3.956372918382063*^9, 
   3.9563729209149227`*^9}, {3.956373200488607*^9, 3.956373255666926*^9}, {
   3.956373307623282*^9, 3.956373319145019*^9}, {3.956373361041877*^9, 
   3.956373421996447*^9}, {3.956373548084998*^9, 3.956373550550377*^9}, {
   3.956373613638913*^9, 3.95637361861779*^9}, 
   3.9563911402062693`*^9},ExpressionUUID->"68bb5463-b148-4485-af84-\
08704b9812d4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"re", "-", 
    RowBox[{
    "order", " ", "the", " ", "fields", " ", "in", " ", "an", " ", "indexed", 
     " ", "object", " ", "t2", " ", "so", " ", "that", " ", "it", " ", "fits",
      " ", "the", " ", "order", " ", "in", " ", 
     RowBox[{"t1", ".", " ", "Returns"}], " ", "both", " ", "the", " ", 
     "sign", " ", "and", " ", "the", " ", "reordered", " ", "t2"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"RearrangeFields", "[", 
     RowBox[{"setup_", ",", "t1_", ",", "t2_", ",", "equiv_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ipos1", ",", "ipos2", ",", "idx", ",", "sign", ",", "newt2"}],
        "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ipos1", "=", 
        RowBox[{
         RowBox[{"FirstPosition", "[", 
          RowBox[{
           RowBox[{"makePosIdx", "/@", 
            RowBox[{"t1", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], ",", 
           RowBox[{"equiv", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ipos2", "=", 
        RowBox[{
         RowBox[{"FirstPosition", "[", 
          RowBox[{
           RowBox[{"makePosIdx", "/@", 
            RowBox[{"t2", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], ",", 
           RowBox[{"equiv", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"nothing", " ", "to", " ", 
         RowBox[{"do", ":"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ipos1", "===", "ipos2"}], ",", 
         RowBox[{"Return", "[", 
          RowBox[{"{", 
           RowBox[{"1", ",", "t2"}], "}"}], "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"sign", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"ipos2", ">", "ipos1"}], ",", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{"commute", " ", "pos2", " ", "backwards"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"FMinus", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "ipos2"}], "]"}], "]"}], ",", 
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", 
                   RowBox[{"ipos2", "-", "idx"}]}], "]"}], "]"}]}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "ipos2"}], "]"}], "]"}], ",", 
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", 
                   RowBox[{"ipos2", "-", "idx"}]}], "]"}], "]"}]}], "}"}]}], 
             "]"}], "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"idx", ",", "1", ",", 
              RowBox[{"ipos2", "-", "ipos1"}]}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{"commute", " ", "pos2", " ", "forwards"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"FMinus", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", "ipos2"}], "]"}], "]"}], ",", 
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"1", ",", 
                   RowBox[{"ipos2", "+", "idx"}]}], "]"}], "]"}]}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "ipos2"}], "]"}], "]"}], ",", 
                RowBox[{"t2", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", 
                   RowBox[{"ipos2", "+", "idx"}]}], "]"}], "]"}]}], "}"}]}], 
             "]"}], "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"idx", ",", "1", ",", 
              RowBox[{"ipos1", "-", "ipos2"}]}], "}"}]}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Resolve", " ", "the", " ", "resulting", " ", "FMinus"}], ",",
          " ", 
         RowBox[{"if", " ", "possible"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"sign", "=", 
        RowBox[{"Times", "@@", 
         RowBox[{"ReduceIndices", "[", 
          RowBox[{"setup", ",", 
           RowBox[{"FTerm", "@@", "sign"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{"Replace", " ", "the", " ", "indices"}], " ", "&"}], " ", 
         "fields", " ", "in", " ", "t2"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"newt2", "=", 
        RowBox[{
         RowBox[{"Head", "[", "t2", "]"}], "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Insert", "[", 
           RowBox[{
            RowBox[{"Delete", "[", 
             RowBox[{
              RowBox[{"t2", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", "ipos2"}], "]"}], ",", 
            RowBox[{"t2", "[", 
             RowBox[{"[", 
              RowBox[{"1", ",", "ipos2"}], "]"}], "]"}], ",", "ipos1"}], 
           "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Insert", "[", 
           RowBox[{
            RowBox[{"Delete", "[", 
             RowBox[{
              RowBox[{"t2", "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", "ipos2"}], "]"}], ",", 
            RowBox[{"t2", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "ipos2"}], "]"}], "]"}], ",", "ipos1"}], 
           "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{"sign", ",", "newt2"}], "}"}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.952058295614352*^9, 3.95205829578233*^9}, 
   3.952151856586349*^9, {3.95355377867379*^9, 3.953553812277306*^9}, {
   3.956334320105116*^9, 3.9563344527315493`*^9}, {3.956335264840496*^9, 
   3.9563352875276546`*^9}, {3.956335871025317*^9, 3.956335883932743*^9}, {
   3.956335916065928*^9, 3.956335923397188*^9}, 3.9563717623634977`*^9, {
   3.9563723579783154`*^9, 3.9563724471406727`*^9}, {3.95637261240427*^9, 
   3.95637263273975*^9}, {3.956372685669449*^9, 3.956372692715972*^9}, {
   3.956372755335157*^9, 3.9563727826080933`*^9}, {3.956372839779771*^9, 
   3.956372909565481*^9}},ExpressionUUID->"bb9f5767-a96a-4b7c-bb09-\
ca8f86332df4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TermsEqualAndSum", "::", "undeterminedFields"}], 
    "=", "\"\<Error: Cannot equate terms if they are not fully truncated, \
i.e. contain instances of AnyField.\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TermsEqualAndSum", "[", 
    RowBox[{"setup_", ",", "it1_FTerm", ",", "it2_FTerm"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"t1", "=", 
        RowBox[{"ReduceIndices", "[", 
         RowBox[{"setup", ",", "it1"}], "]"}]}], ",", 
       RowBox[{"t2", "=", 
        RowBox[{"ReduceIndices", "[", 
         RowBox[{"setup", ",", "it2"}], "]"}]}], ",", "\[IndentingNewLine]", 
       "startPoints", ",", "doFields", ",", "\[IndentingNewLine]", "allObjt1",
        ",", "allObjt2", ",", "\[IndentingNewLine]", "cidxt1", ",", "cidxt2", 
       ",", "oidxt1", ",", "oidxt2", ",", "\[IndentingNewLine]", "startt1", ",",
        "startt1fields", ",", "cidxstartt1", ",", "\[IndentingNewLine]", 
       "startt2", ",", "nstartt2", ",", "startt2fields", ",", "cidxstartt2", ",",
        "branchAllObjt2", ",", "\[IndentingNewLine]", "idx", ",", "jdx", ",", 
       
       RowBox[{"equal", "=", "False"}], ",", "startsign", ",", "a", ",", 
       "factor", ",", "removeOther"}], "}"}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"MemberQ", "[", 
          RowBox[{"t1", ",", "AnyField", ",", "Infinity"}], "]"}], ",", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"TermsEqualAndSum", "::", "undeterminedFields"}], "]"}], ";", 
          RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Briefly", " ", "check", " ", "the", " ", "trivial", " ", "case"}], 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"it1", "===", "it2"}], ",", 
        RowBox[{"Return", "@", 
         RowBox[{"FTerm", "[", 
          RowBox[{"2", ",", "t1"}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"t1", "[", 
          RowBox[{"[", 
           RowBox[{"2", ";;"}], "]"}], "]"}], "===", 
         RowBox[{"t2", "[", 
          RowBox[{"[", 
           RowBox[{"2", ";;"}], "]"}], "]"}]}], ",", 
        RowBox[{"Return", "@", 
         RowBox[{"FTerm", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"t1", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "+", 
            RowBox[{"t2", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], ",", 
           RowBox[{"t1", "[", 
            RowBox[{"[", 
             RowBox[{"2", ";;"}], "]"}], "]"}]}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"t1", "[", 
          RowBox[{"[", 
           RowBox[{"2", ";;"}], "]"}], "]"}], "===", 
         RowBox[{"t2", "[", 
          RowBox[{"[", 
           RowBox[{"1", ";;"}], "]"}], "]"}]}], ",", 
        RowBox[{"Return", "@", 
         RowBox[{"FTerm", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"t1", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "+", "1"}], ",", 
           RowBox[{"t1", "[", 
            RowBox[{"[", 
             RowBox[{"2", ";;"}], "]"}], "]"}]}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"t1", "[", 
          RowBox[{"[", 
           RowBox[{"1", ";;"}], "]"}], "]"}], "===", 
         RowBox[{"t2", "[", 
          RowBox[{"[", 
           RowBox[{"2", ";;"}], "]"}], "]"}]}], ",", 
        RowBox[{"Return", "@", 
         RowBox[{"FTerm", "[", 
          RowBox[{
           RowBox[{"1", "+", 
            RowBox[{"t2", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], ",", 
           RowBox[{"t2", "[", 
            RowBox[{"[", 
             RowBox[{"2", ";;"}], "]"}], "]"}]}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Get", " ", "all", " ", "the", " ", "possible", " ", "starting", " ", 
        "points", " ", "for", " ", "the", " ", "search"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"startPoints", " ", "=", " ", 
       RowBox[{"StartPoints", "[", 
        RowBox[{"setup", ",", "t1", ",", "t2"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"Not", "[", 
         RowBox[{"startPoints", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"FunKitDebug", "[", 
       RowBox[{"4", ",", "\"\<Collected StartPoints\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"doFields", "=", 
       RowBox[{"replFields", "[", "setup", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "collect", " ", "objects", " ", "for", " ", "both", " ", "terms"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"allObjt1", "=", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ExtractObjectsWithIndex", "[", 
           RowBox[{"setup", ",", "t1"}], "]"}], "/.", "doFields"}], ",", 
         RowBox[{"FreeQ", "[", 
          RowBox[{"FMinus", "[", "__", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"allObjt2", "=", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ExtractObjectsWithIndex", "[", 
           RowBox[{"setup", ",", "t2"}], "]"}], "/.", "doFields"}], ",", 
         RowBox[{"FreeQ", "[", 
          RowBox[{"FMinus", "[", "__", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cidxt1", "=", 
       RowBox[{"GetClosedSuperIndices", "[", 
        RowBox[{"setup", ",", "t1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"cidxt2", "=", 
       RowBox[{"GetClosedSuperIndices", "[", 
        RowBox[{"setup", ",", "t2"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"oidxt1", "=", 
       RowBox[{"GetOpenSuperIndices", "[", 
        RowBox[{"setup", ",", "t1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"oidxt2", "=", 
       RowBox[{"GetOpenSuperIndices", "[", 
        RowBox[{"setup", ",", "t2"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "We", " ", "pick", " ", "the", " ", "first", " ", "candidate", " ", 
        "for", " ", "t1", " ", "and", " ", "iterate", " ", "over", " ", "all",
         " ", "candidates", " ", "for", " ", 
        RowBox[{"t2", "."}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"startt1", "=", 
       RowBox[{"startPoints", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"(*", 
       RowBox[{
       "starting", " ", "indices", " ", "can", " ", "only", " ", "be", " ", 
        "closed", " ", 
        RowBox[{"indices", "!"}], " ", "We", " ", "pick", " ", "these", " ", 
        "out", " ", "with", " ", "the", " ", "following", " ", "4", " ", 
        "commands"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"startt1fields", "=", 
       RowBox[{"startt1", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"cidxstartt1", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"MemberQ", "[", 
           RowBox[{"cidxt1", ",", 
            RowBox[{"makePosIdx", "@", "#"}]}], "]"}], "&"}], ",", 
         RowBox[{"startt1", "[", 
          RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"startt1fields", "=", 
       RowBox[{"Pick", "[", 
        RowBox[{"startt1fields", ",", "cidxstartt1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"cidxstartt1", "=", 
       RowBox[{"makePosIdx", "/@", 
        RowBox[{"Pick", "[", 
         RowBox[{
          RowBox[{"startt1", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "cidxstartt1"}], "]"}]}]}], ";",
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Sanity", " ", "check"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "cidxstartt1", "]"}], "===", "0"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"FunKitDebug", "[", 
       RowBox[{
       "3", ",", "\"\<Comparing the terms \\n  \>\"", ",", "t1", 
        ",", "\"\<\\n  \>\"", ",", "t2"}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "If", " ", "the", " ", "terms", " ", "are", " ", "equal", " ", "for", 
         " ", "any", " ", "starting", " ", "candidates", " ", "for", " ", 
         "t2"}], ",", " ", 
        RowBox[{"we", " ", "have", " ", "succeeded"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"idx", "=", "1"}], ",", 
        RowBox[{"idx", "<=", 
         RowBox[{"Length", "[", 
          RowBox[{"startPoints", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "]"}]}], ",", 
        RowBox[{"idx", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "We", " ", "need", " ", "to", " ", "identify", " ", "all", " ", 
          "possible", " ", "insertion", " ", "points", " ", "in", " ", "t2", " ",
           "that", " ", "fit", " ", "the", " ", "insertion", " ", "in", " ", 
          "t1"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"startt2", "=", 
          RowBox[{"startPoints", "[", 
           RowBox[{"[", 
            RowBox[{"3", ",", "idx"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "starting", " ", "indices", " ", "can", " ", "only", " ", "be", " ",
            "1.", " ", "closed", " ", "indices", " ", "2.", " ", "have", " ", 
           "same", " ", "field", " ", "content", " ", "as", " ", "the", " ", 
           "starting", " ", "point", " ", "in", " ", 
           RowBox[{"t1", ".", " ", "We"}], " ", "pick", " ", "these", " ", 
           "out", " ", "with", " ", "the", " ", "following", " ", "2", " ", 
           "commands"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"cidxstartt2", "=", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"MemberQ", "[", 
                RowBox[{"cidxt2", ",", 
                 RowBox[{"#", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "&&", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], "===", 
                RowBox[{"startt1fields", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}]}], ")"}], "&"}], ",", 
            RowBox[{"Transpose", "[", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"makePosIdx", "/@", 
                RowBox[{"startt2", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}], ",", 
               RowBox[{"startt2", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "}"}], "]"}]}], "]"}]}], ";",
          "\[IndentingNewLine]", 
         RowBox[{"cidxstartt2", "=", 
          RowBox[{"Pick", "[", 
           RowBox[{
            RowBox[{"makePosIdx", "/@", 
             RowBox[{"startt2", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", "cidxstartt2"}], "]"}]}],
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", 
          RowBox[{
          "Loop", " ", "over", " ", "all", " ", "possible", " ", "starting", " ",
            "indices"}], "*)"}], "\[IndentingNewLine]", 
         RowBox[{"For", "[", 
          RowBox[{
           RowBox[{"jdx", "=", "1"}], ",", 
           RowBox[{"jdx", "<=", 
            RowBox[{"Length", "[", "cidxstartt2", "]"}]}], ",", 
           RowBox[{"jdx", "++"}], ",", "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"re", "-", 
             RowBox[{
             "order", " ", "the", " ", "starting", " ", "point", " ", "so", " ",
               "that", " ", "it", " ", "fits", " ", "the", " ", 
              RowBox[{"first", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"startsign", ",", "nstartt2"}], "}"}], "=", 
             RowBox[{"RearrangeFields", "[", 
              RowBox[{"setup", ",", "startt1", ",", "startt2", ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"cidxstartt1", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], ",", 
                 RowBox[{"cidxstartt2", "[", 
                  RowBox[{"[", "jdx", "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"FunKitDebug", "[", 
             RowBox[{"3", ",", "\"\<Starting sign: \>\"", ",", "startsign"}], 
             "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"branchAllObjt2", "=", 
             RowBox[{"allObjt2", "/.", 
              RowBox[{"startt2", "->", "nstartt2"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{"iterate", " ", "the", " ", "diagram"}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"FunKitDebug", "[", 
             RowBox[{
             "3", ",", "\"\<StartPoints: \\n  \>\"", ",", "startt1", 
              ",", "\"\<\\n  \>\"", ",", "nstartt2"}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"FunKitDebug", "[", 
             RowBox[{"3", ",", "\"\<StartIndices: \\n  \>\"", ",", 
              RowBox[{"cidxstartt1", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", "\"\<\\n  \>\"", ",", 
              RowBox[{"cidxstartt2", "[", 
               RowBox[{"[", "jdx", "]"}], "]"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"equal", ",", "branchAllObjt2"}], "}"}], "=", 
             RowBox[{"TermsEqualAndSum", "[", 
              RowBox[{
              "setup", ",", "t1", ",", "t2", ",", "\[IndentingNewLine]", 
               "allObjt1", ",", "cidxt1", ",", "oidxt1", ",", 
               RowBox[{"{", "startt1", "}"}], ",", 
               RowBox[{"cidxstartt1", "[", 
                RowBox[{"[", "1", "]"}], "]"}], ",", "\[IndentingNewLine]", 
               "branchAllObjt2", ",", "cidxt2", ",", "oidxt2", ",", 
               RowBox[{"{", "nstartt2", "}"}], ",", 
               RowBox[{"cidxstartt2", "[", 
                RowBox[{"[", "jdx", "]"}], "]"}], ",", "startsign"}], 
              "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"FunKitDebug", "[", 
             RowBox[{"3", ",", "\"\<Finished pass \>\"", ",", 
              RowBox[{"jdx", "\"\< with equal=\>\""}], ",", "equal"}], "]"}], 
            ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
              "If", " ", "we", " ", "found", " ", "an", " ", "equality"}], ",",
               " ", 
              RowBox[{"break", " ", "out"}]}], "*)"}], "\[IndentingNewLine]", 
            
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"equal", "=!=", "False"}], ",", 
              RowBox[{"Break", "[", "]"}]}], "]"}], ";"}]}], 
          "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"equal", "=!=", "False"}], ",", 
           RowBox[{"Break", "[", "]"}]}], "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
         RowBox[{"If", " ", "equal"}], "===", "False"}], ",", " ", 
        RowBox[{
        "the", " ", "terms", " ", "are", " ", "clearly", " ", "not", " ", 
         "equal"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"equal", "===", "False"}], ",", 
        RowBox[{"Return", "[", "False", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"FunKitDebug", "[", 
       RowBox[{"3", ",", "\"\<Found two equal terms\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"removeOther", "=", 
       RowBox[{"Dispatch", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"Alternatives", "@@", 
            RowBox[{"Map", "[", 
             RowBox[{"Blank", ",", 
              RowBox[{"$allObjects", "\[Union]", 
               RowBox[{"{", "FDOp", "}"}]}]}], "]"}]}], "->", "1"}], ",", 
          RowBox[{
           RowBox[{"Alternatives", "@@", 
            RowBox[{"Map", "[", 
             RowBox[{"Blank", ",", 
              RowBox[{
               RowBox[{"GetAllFields", "[", "setup", "]"}], "\[Union]", 
               RowBox[{"{", "AnyField", "}"}]}]}], "]"}]}], "->", "1"}]}], 
         "}"}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "No", " ", "need", " ", "to", " ", "do", " ", "any", " ", "ordering", " ",
         "if", " ", "there", " ", "are", " ", "no", " ", "explicit", " ", 
        "Grassmanns", " ", "in", " ", "the", " ", "expression"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"GrassmannCount", "[", 
          RowBox[{"setup", ",", "t1"}], "]"}], "===", "0"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"factor", "=", 
          FractionBox[
           RowBox[{
            RowBox[{"equal", "*", 
             RowBox[{"Times", "@@", 
              RowBox[{"(", 
               RowBox[{"t2", "/.", "removeOther"}], ")"}]}]}], "+", 
            RowBox[{"Times", "@@", 
             RowBox[{"(", 
              RowBox[{"t1", "/.", "removeOther"}], ")"}]}]}], 
           RowBox[{"Times", "@@", 
            RowBox[{"(", 
             RowBox[{"t1", "/.", "removeOther"}], ")"}]}]]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"FunKitDebug", "[", 
          RowBox[{"3", ",", "\"\<With prefactor: \>\"", ",", "factor"}], 
          "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"Return", "@", 
          RowBox[{"FTerm", "[", 
           RowBox[{"factor", ",", "t1"}], "]"}]}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
      "Print", "[", "\"\<Could not resolve Grassmann factors\>\"", "]"}], ";", 
      RowBox[{"Abort", "[", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "@", 
       RowBox[{"FTerm", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"standardOrderGrassmanns", "[", "t1", "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "*", 
            RowBox[{
             RowBox[{"standardOrderGrassmanns", "[", "t2", "]"}], "[", 
             RowBox[{"[", "1", "]"}], "]"}], "*", "\[IndentingNewLine]", 
            FractionBox[
             RowBox[{
              RowBox[{"equal", "*", 
               RowBox[{"(", 
                RowBox[{"Times", "@@", "t2"}], ")"}]}], "+", 
              RowBox[{"(", 
               RowBox[{"Times", "@@", "t1"}], ")"}]}], 
             RowBox[{"(", 
              RowBox[{"Times", "@@", "t1"}], ")"}]]}], "/.", 
           RowBox[{
            RowBox[{"Alternatives", "@@", 
             RowBox[{"Map", "[", 
              RowBox[{"Blank", ",", 
               RowBox[{"$allObjects", "\[Union]", 
                RowBox[{"{", "FDOp", "}"}]}]}], "]"}]}], "->", "1"}]}], "/.", 
          
          RowBox[{
           RowBox[{"Alternatives", "@@", 
            RowBox[{"Map", "[", 
             RowBox[{"Blank", ",", 
              RowBox[{"GetAllFields", "[", "setup", "]"}]}], "]"}]}], "->", 
           "1"}]}], ",", "t1"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9519242768603783`*^9, 3.9519243478003263`*^9}, {
   3.951924391851883*^9, 3.9519250347088327`*^9}, {3.951925254968196*^9, 
   3.951925276200074*^9}, 3.9519253295624847`*^9, {3.9519254175682096`*^9, 
   3.951925475699326*^9}, {3.951925506872488*^9, 3.951925511393176*^9}, {
   3.951925939348797*^9, 3.9519259458826523`*^9}, {3.9519267107411203`*^9, 
   3.951926717627688*^9}, {3.951926781549156*^9, 3.9519268547427597`*^9}, {
   3.9519269532131147`*^9, 3.951926974201324*^9}, {3.951968307383066*^9, 
   3.951968350148061*^9}, {3.951968392737596*^9, 3.951968393865622*^9}, {
   3.9519716241884823`*^9, 3.951971631462535*^9}, {3.95197169292768*^9, 
   3.95197171293134*^9}, {3.951971885550809*^9, 3.9519720338952703`*^9}, {
   3.9519720710016613`*^9, 3.951972098424197*^9}, {3.951972217956258*^9, 
   3.9519722744769907`*^9}, {3.951972319244841*^9, 3.951972549993887*^9}, {
   3.9519725854265547`*^9, 3.951972809156459*^9}, {3.951972846223724*^9, 
   3.95197284741296*^9}, {3.951973586801158*^9, 3.951973598137828*^9}, {
   3.9519736558910017`*^9, 3.951973907194806*^9}, {3.951974150066578*^9, 
   3.951974253227562*^9}, {3.951974347271823*^9, 3.951974477124996*^9}, {
   3.951974527328267*^9, 3.951974529476536*^9}, {3.951974564892479*^9, 
   3.9519745932306747`*^9}, {3.951974675108328*^9, 3.951974834552627*^9}, {
   3.951974900471737*^9, 3.951974946711741*^9}, {3.951975182260816*^9, 
   3.951975185135453*^9}, {3.951984145381947*^9, 3.951984260453628*^9}, {
   3.951984299781291*^9, 3.951984300888891*^9}, {3.951984562937275*^9, 
   3.951984611371813*^9}, {3.951984818247879*^9, 3.951984820633089*^9}, 
   3.951985395746561*^9, {3.951987501811738*^9, 3.951987501924947*^9}, {
   3.951988107090781*^9, 3.951988147126685*^9}, {3.951988265603862*^9, 
   3.951988265703006*^9}, {3.951988311752831*^9, 3.951988341098681*^9}, {
   3.9519884058470907`*^9, 3.95198840590276*^9}, {3.951988508979492*^9, 
   3.951988512838667*^9}, {3.9520576503520193`*^9, 3.952057671502685*^9}, {
   3.952057710740806*^9, 3.952057781642489*^9}, {3.9520578604120197`*^9, 
   3.952058067128974*^9}, 3.952058388512298*^9, {3.952151701066916*^9, 
   3.952151721658153*^9}, {3.9521517536182537`*^9, 3.952151801949834*^9}, {
   3.9521520666722937`*^9, 3.952152165826305*^9}, {3.952152320898919*^9, 
   3.952152376370994*^9}, {3.9521721215338783`*^9, 3.952172135737245*^9}, {
   3.952172188305743*^9, 3.9521722298365602`*^9}, 3.952262764958647*^9, {
   3.95276060777877*^9, 3.952760645784951*^9}, {3.952760681030533*^9, 
   3.95276068172908*^9}, 3.952760724918542*^9, {3.9527607581546926`*^9, 
   3.952760778642542*^9}, {3.9527611472072353`*^9, 3.9527611715778*^9}, {
   3.9534647880906477`*^9, 3.9534647916467257`*^9}, {3.953464920574979*^9, 
   3.953464998015324*^9}, {3.953465343350974*^9, 3.953465347950766*^9}, {
   3.953466371647739*^9, 3.9534663831567*^9}, {3.953525857378314*^9, 
   3.95352586695045*^9}, {3.9535258984782877`*^9, 3.953525913397996*^9}, {
   3.953525961942462*^9, 3.953525994846923*^9}, {3.953526490687147*^9, 
   3.953526559182488*^9}, 3.9535479306977262`*^9, 3.953553759582556*^9, {
   3.9535538711181107`*^9, 3.953553987606789*^9}, {3.9535543295508823`*^9, 
   3.9535544207112427`*^9}, {3.953554580233749*^9, 3.953554587841494*^9}, 
   3.9535651128501863`*^9, {3.953565143820239*^9, 3.953565207768133*^9}, {
   3.953565239799765*^9, 3.953565312656847*^9}, {3.953567427335738*^9, 
   3.9535674293994617`*^9}, {3.95360709936915*^9, 3.9536071085122967`*^9}, {
   3.9536071931077557`*^9, 3.953607198043642*^9}, {3.953607237492845*^9, 
   3.953607249574029*^9}, {3.953607309864427*^9, 3.953607318924868*^9}, {
   3.953607354680726*^9, 3.953607364232779*^9}, 3.953624995899921*^9, {
   3.95362504012646*^9, 3.95362510529449*^9}, {3.953625808859243*^9, 
   3.9536258840807133`*^9}, {3.9536259231671133`*^9, 
   3.9536259742422647`*^9}, {3.95362603780229*^9, 3.953626041238167*^9}, {
   3.953626611103242*^9, 3.953626613482991*^9}, 3.953626794687478*^9, {
   3.9536269006544657`*^9, 3.9536269089987993`*^9}, {3.953627365858995*^9, 
   3.9536273699420757`*^9}, {3.953627524390587*^9, 3.953627540638451*^9}, {
   3.9536275737720203`*^9, 3.953627604710388*^9}, {3.9536276445347977`*^9, 
   3.9536276648104477`*^9}, {3.953633620944013*^9, 3.953633623926136*^9}, {
   3.95387326434934*^9, 3.953873277705525*^9}, {3.9538752943495903`*^9, 
   3.9538753132503853`*^9}, 3.9539140805171633`*^9, {3.9563311073712254`*^9, 
   3.9563311355015697`*^9}, {3.956331724557541*^9, 3.956331757669557*^9}, 
   3.956331806049328*^9, {3.956332085519699*^9, 3.9563321092219152`*^9}, {
   3.956332152732148*^9, 3.9563321637093763`*^9}, {3.956332221957996*^9, 
   3.956332234633801*^9}, {3.95633226555403*^9, 3.956332271945497*^9}, {
   3.956377805841627*^9, 3.9563778898759623`*^9}, {3.9563779361806517`*^9, 
   3.956377948620461*^9}, {3.9563780189950037`*^9, 3.9563781135584097`*^9}, {
   3.956389077273403*^9, 
   3.956389103016415*^9}},ExpressionUUID->"68bf7fec-9348-4f26-b75f-\
c58e2500fc27"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FTermContent", "[", 
    RowBox[{"setup_", ",", "term_FTerm"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Hash", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Sort", "@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Head", "[", "#", "]"}], "[", 
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], "&"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"FunKit`Private`ExtractObjectsWithIndex", "[", 
            RowBox[{"setup", ",", "term"}], "]"}], "/.", 
           RowBox[{"FunKit`Private`replFields", "[", "setup", "]"}]}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", 
       "\"\<SHA\>\""}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.953568444465905*^9, 3.9535685936027718`*^9}, {
  3.953568794322967*^9, 3.9535688403468*^9}, {3.953568885626787*^9, 
  3.9535689399149637`*^9}, {3.953868740692008*^9, 3.9538687437476873`*^9}, {
  3.953868808623955*^9, 
  3.953868829929882*^9}},ExpressionUUID->"6772d278-9e9f-4838-97ca-\
57b9a744f0dd"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"SeparateTermGroups", "[", 
    RowBox[{"setup_", ",", "expr_FEq"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ret", "=", 
        RowBox[{"List", "@@", "expr"}]}], ",", "identifierRep", ",", 
       "removeFirsts", ",", "groupedDiagrams"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "We", " ", "group", " ", "all", " ", "diagrams", " ", "into", " ", 
       "groups", " ", "that", " ", "could", " ", "be", " ", "potentially", 
       " ", 
       RowBox[{"identical", ".", "\[IndentingNewLine]", "We"}], " ", "simply",
        " ", "make", " ", "sure", " ", "that", " ", "in", " ", "each", " ", 
       "group", " ", "all", " ", "diagrams", " ", "have", " ", "the", " ", 
       "same", " ", 
       RowBox[{"objects", "."}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"identifierRep", "=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"FTermContent", "[", 
           RowBox[{"setup", ",", "#"}], "]"}], "&"}], ",", "ret"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"identifierRep", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{"{", 
         RowBox[{"identifierRep", ",", "ret"}], "}"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"removeFirsts", "[", "ex_", "]"}], ":=", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "&"}], ",", "ex"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"groupedDiagrams", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"FEq", "@@", "#"}], ")"}], "&"}], "/@", 
        RowBox[{"Map", "[", 
         RowBox[{"removeFirsts", ",", 
          RowBox[{"GatherBy", "[", 
           RowBox[{"identifierRep", ",", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "&"}]}], "]"}]}], "]"}]}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"FunKitDebug", "[", 
       RowBox[{"2", ",", "\"\<Separated into \>\"", ",", 
        RowBox[{"Length", "[", "groupedDiagrams", "]"}], ",", 
        "\"\< groups.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "groupedDiagrams", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.953568380678402*^9, 3.953568403170219*^9}, {
   3.953568436682513*^9, 3.9535684417783527`*^9}, {3.9535685962988253`*^9, 
   3.953568661547454*^9}, {3.953568740019177*^9, 3.953568778618281*^9}, {
   3.953568949671791*^9, 3.9535689962582827`*^9}, 3.9535690880359163`*^9, {
   3.953625225464981*^9, 3.9536252617657022`*^9}, 
   3.953625353372933*^9},ExpressionUUID->"383d0d1a-9664-4758-816f-\
92cc89059461"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"SubFSimplify", "[", 
    RowBox[{"setup_", ",", "expr_FEq"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ret", "=", 
        RowBox[{"List", "@@", "expr"}]}], ",", "idx", ",", "jdx", ",", 
       "red"}], "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"idx", "=", "1"}], ",", 
        RowBox[{"idx", "<=", 
         RowBox[{"Length", "[", "ret", "]"}]}], ",", 
        RowBox[{"idx", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"For", "[", 
          RowBox[{
           RowBox[{"jdx", "=", 
            RowBox[{"idx", "+", "1"}]}], ",", 
           RowBox[{"jdx", "<=", 
            RowBox[{"Length", "[", "ret", "]"}]}], ",", 
           RowBox[{"jdx", "++"}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"red", "=", 
             RowBox[{"TermsEqualAndSum", "[", 
              RowBox[{"setup", ",", 
               RowBox[{"ret", "[", 
                RowBox[{"[", "idx", "]"}], "]"}], ",", 
               RowBox[{"ret", "[", 
                RowBox[{"[", "jdx", "]"}], "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"red", "=!=", "False"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"ret", "[", 
                 RowBox[{"[", "idx", "]"}], "]"}], "=", "red"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"ret", "=", 
                RowBox[{"Delete", "[", 
                 RowBox[{"ret", ",", "jdx"}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"jdx", "--"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
            ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", 
       RowBox[{"FEq", "@@", "ret"}], "]"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9520583936594467`*^9, 3.952058393830222*^9}, {
   3.953444643619338*^9, 3.9534446513024673`*^9}, {3.953445134208609*^9, 
   3.953445134619419*^9}, {3.953553824273932*^9, 3.953553840041472*^9}, {
   3.9535690156104383`*^9, 3.953569084606144*^9}, {3.953569125306493*^9, 
   3.953569127902133*^9}, {3.953569161114393*^9, 3.953569188383136*^9}, {
   3.953569287723208*^9, 3.9535693551061172`*^9}, {3.953625167749815*^9, 
   3.953625168092696*^9}, {3.953625319300783*^9, 3.9536253236247*^9}, {
   3.953625373923691*^9, 3.9536253866364107`*^9}, {3.953626849849185*^9, 
   3.953626867918182*^9}, {3.9536295411613083`*^9, 3.95362954196912*^9}, 
   3.953633993666297*^9, 3.953634246067732*^9, {3.956377746694085*^9, 
   3.956377763945847*^9}, {3.95638887113431*^9, 3.956388882854631*^9}, 
   3.956389155616675*^9},ExpressionUUID->"6efa3890-ba43-4adc-bfb2-\
cc7d940c7ce8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BuildSymmetryList", "[", 
     RowBox[{"setup_", ",", "symmetries_", ",", "derivativeList_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"procDerList", ",", "buildOneSymmetry"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Head", "[", "symmetries", "]"}], "=!=", "List"}], ",", 
         RowBox[{
          RowBox[{
          "Print", "[", "\"\<Symmetries must be given as a list!\>\"", "]"}], 
          ";", 
          RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "symmetries", "]"}], "==", "0"}], ",", 
         RowBox[{"Return", "[", 
          RowBox[{"{", "}"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "derivativeList", "]"}], "==", "0"}], ",", 
         RowBox[{"Return", "[", 
          RowBox[{"{", "}"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"procDerList", "=", 
        RowBox[{"derivativeList", "/.", 
         RowBox[{"unreplFields", "[", "setup", "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"buildOneSymmetry", "[", "sym_", "]"}], ":=", 
        RowBox[{"Module", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"valid", "=", "True"}], ",", "buildCycle", ",", "pairs"}],
            "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"AnyTrue", "[", 
              RowBox[{
               RowBox[{"sym", "[", 
                RowBox[{"[", 
                 RowBox[{";;", 
                  RowBox[{"-", "2"}]}], "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"Not", "[", 
                 RowBox[{
                  RowBox[{"Head", "[", "#", "]"}], "===", "List"}], "]"}], 
                "&"}]}], "]"}], ",", 
             RowBox[{"valid", "=", "False"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"pairs", "=", 
            RowBox[{"Subsets", "[", 
             RowBox[{
              RowBox[{"sym", "[", 
               RowBox[{"[", 
                RowBox[{";;", 
                 RowBox[{"-", "2"}]}], "]"}], "]"}], ",", 
              RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
           
           RowBox[{"valid", "=", 
            RowBox[{"Not", "@", 
             RowBox[{"AnyTrue", "[", 
              RowBox[{
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"ContainsAny", "[", 
                   RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "&"}], ",", 
                 "pairs"}], "]"}], ",", "Identity"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"Not", "@", "valid"}], ",", 
             RowBox[{
              RowBox[{"Print", "[", 
               RowBox[{"sym", ",", "\"\< is  not a valid symmetry!\>\""}], 
               "]"}], ";", 
              RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"buildCycle", "[", "cyc_", "]"}], ":=", 
            RowBox[{"Module", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"cycvalid", "=", "True"}], ",", "numberRules", ",", 
                "idx", ",", "nextIdx"}], "}"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"AnyTrue", "[", 
                  RowBox[{"cyc", ",", 
                   RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"IntegerQ", "[", "#", "]"}], "]"}], "&"}]}], 
                  "]"}], ",", 
                 RowBox[{"cycvalid", "=", "False"}]}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"AnyTrue", "[", 
                  RowBox[{"cyc", ",", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"#", ">", 
                    RowBox[{"Length", "[", "derivativeList", "]"}]}], ")"}], "||", 
                    RowBox[{"(", 
                    RowBox[{"#", "<", "1"}], ")"}]}], "&"}]}], "]"}], ",", 
                 RowBox[{"cycvalid", "=", "False"}]}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"Not", "@", "cycvalid"}], ",", 
                 RowBox[{
                  RowBox[{"Print", "[", 
                   RowBox[{"cyc", ",", "\"\< is  not a valid cycle!\>\""}], 
                   "]"}], ";", 
                  RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"numberRules", "=", 
                RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"For", "[", 
                RowBox[{
                 RowBox[{"idx", "=", "1"}], ",", 
                 RowBox[{"idx", "<=", 
                  RowBox[{"Length", "[", "cyc", "]"}]}], ",", 
                 RowBox[{"idx", "++"}], ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"nextIdx", "=", 
                   RowBox[{
                    RowBox[{"Mod", "[", 
                    RowBox[{
                    RowBox[{"(", "idx", ")"}], ",", 
                    RowBox[{"Length", "[", "cyc", "]"}]}], "]"}], "+", 
                    "1"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"numberRules", "=", 
                   RowBox[{"Join", "[", 
                    RowBox[{"numberRules", ",", 
                    RowBox[{"{", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"cyc", "[", 
                    RowBox[{"[", "idx", "]"}], "]"}], ",", 
                    RowBox[{"cyc", "[", 
                    RowBox[{"[", "nextIdx", "]"}], "]"}]}], "}"}], "}"}]}], 
                    "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"Return", "[", 
                RowBox[{"Map", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{"procDerList", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", "1"}], "]"}], "]"}], 
                    "->", 
                    RowBox[{"procDerList", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"#", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], "&"}], ",", "numberRules"}], "]"}], "]"}], 
               ";"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"<|", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"\"\<Rule\>\"", "->", 
              RowBox[{"Flatten", "[", 
               RowBox[{
                RowBox[{"Map", "[", 
                 RowBox[{"buildCycle", ",", 
                  RowBox[{"sym", "[", 
                   RowBox[{"[", 
                    RowBox[{";;", 
                    RowBox[{"-", "2"}]}], "]"}], "]"}]}], "]"}], ",", "1"}], 
               "]"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"\"\<Factor\>\"", "->", 
              RowBox[{"sym", "[", 
               RowBox[{"[", 
                RowBox[{"-", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
            "|>"}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Return", "@", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"<|", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"\"\<Rule\>\"", "->", 
              RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"\"\<Factor\>\"", "->", "1"}]}], "\[IndentingNewLine]", 
            "|>"}], "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Map", "[", 
           RowBox[{"buildOneSymmetry", ",", 
            RowBox[{"symmetries", "/.", 
             RowBox[{"Cycles", "->", "Identity"}]}]}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], ";"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SubFSimplify", "[", 
     RowBox[{"setup_", ",", "expr_FEq", ",", "symmetryList_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ret", "=", 
         RowBox[{"List", "@@", "expr"}]}], ",", "idx", ",", "jdx", ",", "kdx",
         ",", "red"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"idx", "=", "1"}], ",", 
         RowBox[{"idx", "<=", 
          RowBox[{"Length", "[", "ret", "]"}]}], ",", 
         RowBox[{"idx", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"For", "[", 
           RowBox[{
            RowBox[{"jdx", "=", 
             RowBox[{"idx", "+", "1"}]}], ",", 
            RowBox[{"jdx", "<=", 
             RowBox[{"Length", "[", "ret", "]"}]}], ",", 
            RowBox[{"jdx", "++"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"For", "[", 
              RowBox[{
               RowBox[{"kdx", "=", "1"}], ",", 
               RowBox[{"kdx", "<=", 
                RowBox[{"Length", "[", "symmetryList", "]"}]}], ",", 
               RowBox[{"kdx", "++"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"red", "=", 
                 RowBox[{
                  RowBox[{"symmetryList", "[", 
                   RowBox[{"[", 
                    RowBox[{"kdx", ",", 
                    RowBox[{"Key", "[", "\"\<Factor\>\"", "]"}]}], "]"}], 
                   "]"}], "*", 
                  RowBox[{"TermsEqualAndSum", "[", 
                   RowBox[{"setup", ",", 
                    RowBox[{"ret", "[", 
                    RowBox[{"[", "idx", "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"ret", "[", 
                    RowBox[{"[", "jdx", "]"}], "]"}], "/.", 
                    RowBox[{"symmetryList", "[", 
                    RowBox[{"[", 
                    RowBox[{"kdx", ",", 
                    RowBox[{"Key", "[", "\"\<Rule\>\"", "]"}]}], "]"}], 
                    "]"}]}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"red", "=!=", "False"}], ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"ret", "[", 
                    RowBox[{"[", "idx", "]"}], "]"}], "=", "red"}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"ret", "=", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"ret", ",", "jdx"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"jdx", "--"}], ";", 
                   RowBox[{"kdx", "=", 
                    RowBox[{
                    RowBox[{"Length", "[", "symmetryList", "]"}], "+", 
                    "1"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
              "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Return", "[", 
        RowBox[{"FEq", "@@", "ret"}], "]"}], ";"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FSimplifyNoSym", "[", 
     RowBox[{"setup_", ",", "expr_FEq"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"subGroups", ",", "res"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"FunKitDebug", "[", 
        RowBox[{
        "1", ",", "\"\<Simplifying diagrammatic expression of length \>\"", ",", 
         RowBox[{"Length", "[", "expr", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"subGroups", "=", 
        RowBox[{"SeparateTermGroups", "[", 
         RowBox[{"setup", ",", "expr"}], "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"res", "=", 
        RowBox[{"FEq", "@@", 
         RowBox[{"ParallelMap", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"SubFSimplify", "[", 
             RowBox[{"setup", ",", "#"}], "]"}], "&"}], ",", "subGroups"}], 
          "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"FunKitDebug", "[", 
        RowBox[{"1", ",", "\"\<FTerms before: \>\"", ",", 
         RowBox[{"Length", "[", "expr", "]"}], ",", "\"\<, after: \>\"", ",", 
         
         RowBox[{"Length", "[", "res", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Return", "[", "res", "]"}], ";"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "FSimplify", "]"}], "=", 
    RowBox[{"{", 
     RowBox[{"\"\<Symmetries\>\"", "->", 
      RowBox[{"{", "}"}]}], "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FSimplify", "[", 
    RowBox[{"setup_", ",", "expr_FEq", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"subGroups", ",", "res", ",", "symmetryList"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<Symmetries\>\"", "]"}], "===", 
         RowBox[{"{", "}"}]}], ",", 
        RowBox[{"Return", "[", 
         RowBox[{"FSimplifyNoSym", "[", 
          RowBox[{"setup", ",", "expr"}], "]"}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"FunKitDebug", "[", 
       RowBox[{
       "1", ",", "\"\<Simplifying diagrammatic expression of length \>\"", ",", 
        RowBox[{"Length", "[", "expr", "]"}], 
        ",", "\"\<with symmetry list\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"subGroups", "=", 
       RowBox[{"SeparateTermGroups", "[", 
        RowBox[{"setup", ",", "expr"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"symmetryList", "=", 
       RowBox[{"BuildSymmetryList", "[", 
        RowBox[{"setup", ",", 
         RowBox[{
          RowBox[{"OptionValue", "[", "\"\<Symmetries\>\"", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"AnyField", "[", "#", "]"}], "&"}], "/@", 
          RowBox[{
           RowBox[{"OptionValue", "[", "\"\<Symmetries\>\"", "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"res", "=", 
       RowBox[{"FEq", "@@", 
        RowBox[{"ParallelMap", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"SubFSimplify", "[", 
            RowBox[{"setup", ",", "#", ",", "symmetryList"}], "]"}], "&"}], ",",
           "subGroups"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"FunKitDebug", "[", 
       RowBox[{"1", ",", "\"\<FTerms before: \>\"", ",", 
        RowBox[{"Length", "[", "expr", "]"}], ",", "\"\<, after: \>\"", ",", 
        RowBox[{"Length", "[", "res", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "res", "]"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.9322339551217957`*^9, 3.932234123632927*^9}, {
   3.9322341641177597`*^9, 3.932234175374415*^9}, {3.932234823270101*^9, 
   3.932234947885703*^9}, {3.932235242772088*^9, 3.9322353815413017`*^9}, {
   3.932235415383548*^9, 3.932235873527635*^9}, {3.932235910478104*^9, 
   3.932236122016565*^9}, {3.932273061519869*^9, 3.932273664470671*^9}, {
   3.932273696855605*^9, 3.932273729198847*^9}, {3.932273765584857*^9, 
   3.932273787842926*^9}, {3.9534447187165003`*^9, 3.9534447421503563`*^9}, {
   3.953444805657947*^9, 3.9534448115912*^9}, {3.953444876894104*^9, 
   3.9534448781557093`*^9}, {3.953444992041005*^9, 3.953445192003043*^9}, 
   3.953445245195904*^9, {3.9534454550256987`*^9, 3.953445537683052*^9}, 
   3.953445759823988*^9, {3.953445796555784*^9, 3.953445931956613*^9}, {
   3.953446025612514*^9, 3.953446031092415*^9}, {3.953446443491413*^9, 
   3.953446445854959*^9}, {3.953446532393211*^9, 3.953446540047344*^9}, {
   3.953446580583275*^9, 3.953446600655785*^9}, 3.95344691480118*^9, {
   3.953553844914464*^9, 3.953553850317266*^9}, {3.9536338942966557`*^9, 
   3.95363398929893*^9}, {3.953634249462986*^9, 3.953634358418318*^9}, {
   3.953634413210408*^9, 3.953634414282365*^9}, {3.956388595145236*^9, 
   3.956388608186982*^9}, {3.956388761914253*^9, 3.956388797752803*^9}, 
   3.9563888626916647`*^9},ExpressionUUID->"0eda9edb-8975-4760-9b07-\
84c3e6630de5"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Private", "Section",
 CellChangeTimes->{{3.9509597231601686`*^9, 3.950959732923991*^9}, {
  3.951108540108012*^9, 3.9511085438759727`*^9}, {3.951210853720582*^9, 
  3.95121085660688*^9}, {3.951719085230523*^9, 3.951719086330667*^9}, {
  3.95339039462521*^9, 
  3.953390408535656*^9}},ExpressionUUID->"2fd28ac1-06a7-4e15-a3be-\
883aa7db8017"],

Cell[BoxData[
 RowBox[{
  RowBox[{"End", "[", "]"}], ";"}]], "Code",
 CellChangeTimes->{
  3.933840441045422*^9, {3.953390410137535*^9, 
   3.953390412999981*^9}},ExpressionUUID->"ef7e7a94-8fc4-486e-a2f3-\
832f01b9f234"]
}, Closed]]
}, Open  ]]
},
AutoGeneratedPackage->"AnSEL.m",
WindowSize->{1440, 779},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
Magnification:>0.7 Inherited,
FrontEndVersion->"14.2 for Mac OS X ARM (64-bit) (March 16, 2025)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"dfc92765-bf29-47cf-bd50-cf1f31dcd525"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 577, 11, 21, "Input",ExpressionUUID->"33cd48af-4550-42b3-9c95-127f2f1ee635"],
Cell[CellGroupData[{
Cell[1156, 35, 206, 3, 67, "Title",ExpressionUUID->"45e0855c-4bc3-42ae-aaff-d5b51f4ff40a"],
Cell[CellGroupData[{
Cell[1387, 42, 299, 5, 46, "Section",ExpressionUUID->"e11489d7-57c3-46f3-92a7-9bd632e0d9ac"],
Cell[1689, 49, 1150, 30, 144, "Input",ExpressionUUID->"0d5d392c-52cd-44ef-853d-02a6cf9d51ce",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[2876, 84, 353, 6, 37, "Section",ExpressionUUID->"445e38bc-f471-4fa5-8f01-377cf28ca16d"],
Cell[3232, 92, 293, 7, 36, "Code",ExpressionUUID->"466d64ef-678a-421d-bafe-cb91fb62b4c6"]
}, Closed]],
Cell[CellGroupData[{
Cell[3562, 104, 319, 5, 37, "Section",ExpressionUUID->"1b5ba65f-49a1-4935-a430-53c938d8e351"],
Cell[3884, 111, 2360, 63, 108, "Input",ExpressionUUID->"dd231b36-4dd1-41ed-8027-d5c3d185d878",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[6281, 179, 259, 4, 37, "Section",ExpressionUUID->"d65e8f2b-6500-4348-8918-912b67b13cd9"],
Cell[6543, 185, 2103, 50, 211, "Input",ExpressionUUID->"0a00f2e0-9e12-4855-8a8a-da6773cee6a6",
 InitializationCell->True],
Cell[8649, 237, 2442, 59, 203, "Input",ExpressionUUID->"19d3217d-a7f5-4ace-98d5-bc282d55350e",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[11128, 301, 356, 6, 37, "Section",ExpressionUUID->"9aa34791-bba0-4b08-b6c9-8fe4e2793307"],
Cell[11487, 309, 1250, 31, 117, "Input",ExpressionUUID->"42d0a911-1a57-464e-87cc-ca3a6c174093",
 InitializationCell->True],
Cell[12740, 342, 54096, 1153, 2905, "Input",ExpressionUUID->"cdeb8713-24bf-460c-884a-cc213810ba39",
 InitializationCell->True],
Cell[66839, 1497, 2373, 63, 174, "Input",ExpressionUUID->"00de0eae-0500-4dd8-ab98-ad7243272911",
 InitializationCell->True],
Cell[69215, 1562, 2960, 78, 146, "Input",ExpressionUUID->"c340c07d-b807-41f4-980c-ceb8b55933ad",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[72212, 1645, 323, 5, 46, "Section",ExpressionUUID->"855a16af-fad8-4dc3-a58a-bba72dca9d84"],
Cell[72538, 1652, 11486, 238, 575, "Input",ExpressionUUID->"475d9bdd-2660-454f-a06f-4505f5c4aa8c",
 InitializationCell->True],
Cell[84027, 1892, 3513, 82, 231, "Input",ExpressionUUID->"f2ce13a1-b99d-4d24-ba77-209c21a7becd",
 InitializationCell->True],
Cell[87543, 1976, 37177, 765, 2190, "Input",ExpressionUUID->"68bb5463-b148-4485-af84-08704b9812d4",
 InitializationCell->True],
Cell[124723, 2743, 7203, 171, 432, "Input",ExpressionUUID->"bb9f5767-a96a-4b7c-bb09-ca8f86332df4",
 InitializationCell->True],
Cell[131929, 2916, 25668, 557, 1448, "Input",ExpressionUUID->"68bf7fec-9348-4f26-b75f-c58e2500fc27",
 InitializationCell->True],
Cell[157600, 3475, 1302, 32, 117, "Input",ExpressionUUID->"6772d278-9e9f-4838-97ca-57b9a744f0dd",
 InitializationCell->True],
Cell[158905, 3509, 2914, 70, 174, "Input",ExpressionUUID->"383d0d1a-9664-4758-816f-92cc89059461",
 InitializationCell->True],
Cell[161822, 3581, 3056, 67, 231, "Input",ExpressionUUID->"6efa3890-ba43-4adc-bfb2-cc7d940c7ce8",
 InitializationCell->True],
Cell[164881, 3650, 17896, 415, 1147, "Input",ExpressionUUID->"0eda9edb-8975-4760-9b07-84c3e6630de5",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[182814, 4070, 351, 6, 46, "Section",ExpressionUUID->"2fd28ac1-06a7-4e15-a3be-883aa7db8017"],
Cell[183168, 4078, 220, 6, 36, "Code",ExpressionUUID->"ef7e7a94-8fc4-486e-a2f3-832f01b9f234"]
}, Closed]]
}, Open  ]]
}
]
*)

